<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Profile ‚Äî MY SHELF</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;700&display=swap');

    :root{
      --bg:#222; --text:#eee; --muted:#bbb; --panel:rgba(34,34,34,.9);
      --line:rgba(255,255,255,.12); --soft:#444; --brand:#fff; --accent:#00c4b4;
      --radius:16px; --shadow:0 10px 24px rgba(0,0,0,.45);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;line-height:1.6;
      font-family:'Noto Sans Thai',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
      background:var(--bg) url('{{ url_for("static", filename="img/bg-login.jpg") }}') center/cover fixed no-repeat;
      color:var(--text);
    }

    /* Header */
    header{position:sticky;top:0;z-index:30;background:rgba(34,34,34,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
    .nav{max-width:1200px;margin:0 auto;padding:10px 20px;display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center}
    .brand{font-family:Georgia,'Times New Roman',serif;font-size:1.6rem;letter-spacing:.25em;font-weight:700;text-align:center}
    .nav-ctls{display:flex;gap:10px;justify-content:flex-end}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--soft);background:#111214;color:#eee;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:.4rem}
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px)}
    .btn.small{padding:8px 12px;border-radius:10px;font-size:.95rem}
    .btn.primary{background:var(--brand);color:#000;border-color:var(--brand)}
    .btn.outline{background:transparent}

    /* Layout */
    .site{max-width:1000px;margin:0 auto;padding:24px}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:22px}

    .grid{display:grid;grid-template-columns:260px 1fr;gap:26px;align-items:start}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}

    .avatar-wrap{display:grid;place-items:center;gap:14px}
    .avatar{width:220px;height:220px;border-radius:50%;background:#d9d9dc;border:1px solid var(--line);object-fit:cover;display:block}
    .avatar-ctls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center}

    .form{display:grid;gap:14px}
    .field{display:grid;gap:8px}
    .label{color:var(--muted)}
    .input, .select{width:100%;background:#ddd;color:#111;border:0;border-radius:14px;padding:12px 14px;font-size:1rem}
    .pwd-row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
    .toggle{padding:10px 12px;border-radius:12px;border:1px solid var(--soft);background:#111214;color:#eee;cursor:pointer}

    .gender-row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width: 600px){.gender-row{grid-template-columns:1fr}}

    .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
    .muted{color:var(--muted)}

    .hint{font-size:.9rem;color:var(--muted)}
    .meter{height:8px;border-radius:999px;background:#333;border:1px solid var(--line);overflow:hidden}
    .bar{height:100%;width:0;background:#ffcc00;transition:width .25s}

    /* Utility */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="sticky top-0 z-30 border-b border-white/10 bg-bg/80 backdrop-blur-md">
    {% include 'header.html' %}
  </header>

  <main class="site">
    <section class="panel">
      <h1 style="margin:0 0 14px;font-size:1.6rem">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</h1>

      <form id="profileForm" class="grid" method="post" action="{{ url_for('profile.profileusers') }}" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <!-- LEFT: Avatar -->
        <div class="avatar-wrap">
          <img id="avatarPreview" class="avatar" src="{{ user.avatar_url or url_for('static', filename='profile/default.png') }}" alt="avatar">
          <div class="avatar-ctls">
            <label class="btn" for="avatarInput">üì∑ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</label>
            <input id="avatarInput" type="file" name="avatar" accept="image/*" hidden>
            <button class="btn" type="button" id="removeAvatar">‡∏•‡∏ö‡∏£‡∏π‡∏õ</button>
          </div>
          <input type="hidden" name="remove_avatar" id="removeFlag" value="">
          <div class="hint">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö JPG/PNG (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 2MB)</div>
        </div>

        <!-- RIGHT: Editable fields -->
        <div class="form">
          <div class="field">
            <label class="label" for="username">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
            <input id="username" class="input" type="text" name="username" value="{{ user.username }}" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" autocomplete="username">
            <div class="hint">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</div>
          </div>

          <div class="field">
            <label class="label" for="email">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
            <input id="email" class="input" type="email" name="email" value="{{ user.email or '' }}" placeholder="your@email.com" autocomplete="email">
          </div>

          <!-- Gender field -->
          <div class="field">
            <label class="label" for="gender">‡πÄ‡∏û‡∏®</label>
            <div class="gender-row">
              <select id="gender" class="select" name="gender">
                <option value="" {{ '' == (user.gender or '') and 'selected' or '' }}>‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
                <option value="male" {{ 'male' == (user.gender or '') and 'selected' or '' }}>‡∏ä‡∏≤‡∏¢</option>
                <option value="female" {{ 'female' == (user.gender or '') and 'selected' or '' }}>‡∏´‡∏ç‡∏¥‡∏á</option>
                <option value="LGBTQ+" {{ 'LGBTQ+' == (user.gender or '') and 'selected' or '' }}>LGBTQ+</option>
              </select>
              <div class="hint">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</div>
            </div>
          </div>

          <div class="field">
            <label class="label" for="pwdCurrent">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
            <div class="pwd-row">
              <input class="input" type="password" id="pwdCurrent" name="password_current" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°" autocomplete="current-password">
              <button class="toggle" type="button" data-target="pwdCurrent">‡πÅ‡∏™‡∏î‡∏á</button>
            </div>
          </div>

          <div class="field">
            <label class="label" for="pwdNew">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
            <div class="pwd-row">
              <input class="input" type="password" id="pwdNew" name="password_new" placeholder="‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£" autocomplete="new-password">
              <button class="toggle" type="button" data-target="pwdNew">‡πÅ‡∏™‡∏î‡∏á</button>
            </div>
          </div>

          <div class="field">
            <label class="label" for="pwdConfirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà</label>
            <div class="pwd-row">
              <input class="input" type="password" id="pwdConfirm" name="password_confirm" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ã‡πâ‡∏≥‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" autocomplete="new-password">
              <button class="toggle" type="button" data-target="pwdConfirm">‡πÅ‡∏™‡∏î‡∏á</button>
            </div>
            <div class="hint" id="matchHint"></div>
          </div>

          <div class="field">
            <div class="hint">
              ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: {{ user.created_at or '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö' }}<br>
              ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {{ user.updated_at or '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö' }}
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" type="submit">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
            <button class="btn" type="submit">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          </div>
        </div>
      </form>
    </section>
  </main>

  <script>
    // Preview avatar
    const avatarInput = document.getElementById('avatarInput');
    const avatarPreview = document.getElementById('avatarPreview');
    const removeBtn = document.getElementById('removeAvatar');
    const removeFlag = document.getElementById('removeFlag');

    avatarInput.addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      if(!file.type.startsWith('image/')) return alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û');
      if(file.size > 2*1024*1024) return alert('‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏à‡∏≥‡∏Å‡∏±‡∏î 2MB)');
      const reader = new FileReader();
      reader.onload = ev => avatarPreview.src = ev.target.result;
      reader.readAsDataURL(file);
      removeFlag.value = ''; // ‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö
    });

    removeBtn.addEventListener('click', ()=>{
      avatarPreview.src = '{{ url_for("static", filename="profile/default.png") }}';
      avatarInput.value = '';
      removeFlag.value = '1'; // ‡πÅ‡∏à‡πâ‡∏á backend ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏£‡∏π‡∏õ
    });

    // Toggle password visibility
    document.querySelectorAll('.toggle').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.getAttribute('data-target');
        const input = document.getElementById(id);
        if(!input) return;
        input.type = input.type === 'password' ? 'text' : 'password';
        btn.textContent = input.type === 'password' ? '‡πÅ‡∏™‡∏î‡∏á' : '‡∏ã‡πà‡∏≠‡∏ô';
      });
    });

    // Password strength
    const pwdNew = document.getElementById('pwdNew');
    const bar = document.getElementById('strengthBar');
    function strength(s){
      let score = 0;
      if(s.length>=8) score+=25;
      if(/[A-Z]/.test(s)) score+=25;
      if(/[0-9]/.test(s)) score+=25;
      if(/[^A-Za-z0-9]/.test(s)) score+=25;
      return score;
    }
    pwdNew.addEventListener('input',()=>{
      const sc = strength(pwdNew.value);
      bar.style.width = sc+'%';
      bar.style.background = sc>75? '#15c975' : sc>50? '#ffcc00' : '#ff7b7b';
    });

    // Match hint
    const pwdConfirm = document.getElementById('pwdConfirm');
    const matchHint = document.getElementById('matchHint');
    function checkMatch(){
      const ok = pwdNew.value && pwdNew.value === pwdConfirm.value;
      matchHint.textContent = ok ? '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô' : (pwdConfirm.value? '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô' : '');
      matchHint.style.color = ok? '#15c975' : '#ffb3b3';
      return ok;
    }
    pwdNew.addEventListener('input', checkMatch);
    pwdConfirm.addEventListener('input', checkMatch);

    // Gender: enable/disable other field
    const gender = document.getElementById('gender');
    const genderOther = document.getElementById('genderOther');
    function syncGenderOther(){
      const isOther = gender.value === 'other';
      genderOther.disabled = !isOther;
      if(isOther){
        genderOther.focus();
      } else {
        genderOther.value = '';
      }
    }
    gender.addEventListener('change', syncGenderOther);
    syncGenderOther();

    // Validate before submit
    document.getElementById('profileForm').addEventListener('submit',(e)=>{
      // If password fields provided, ensure they match
      if(pwdNew.value || pwdConfirm.value){
        if(!checkMatch()){
          e.preventDefault();
          alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
          return;
        }
      }
      // If other gender selected, require text
      if(gender.value === 'other' && !genderOther.value.trim()){
        e.preventDefault();
        alert('‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏û‡∏®‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á "‡∏≠‡∏∑‡πà‡∏ô ‡πÜ"');
      }
    });
  </script>
</body>
</html>
