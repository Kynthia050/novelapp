<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>สร้างนิยายใหม่ - MYSHELF</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;700&display=swap');

    :root{
      --bg:#1f1f22; --text:#f2f2f3; --panel:rgba(30,30,33,.9);
      --muted:#bdbdbf; --line:#68686d; --line-soft:#3a3a41;
      --brand:#00d4ff; --ok:#00ff88; --danger:#ff4d4f;
      --radius:16px; --shadow:0 8px 24px rgba(0,0,0,.45); --maxw:1200px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:'Noto Sans Thai', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg) url('{{ url_for("static", filename="img/bg-login.jpg") }}') no-repeat center/cover fixed;
      color:var(--text); line-height:1.65;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }


    /* ===== Page ===== */
    .main{max-width:var(--maxw);margin:0 auto;padding:clamp(16px,3vw,28px)}
    .panel{background:var(--panel);box-shadow:var(--shadow);border-radius:var(--radius);
      padding:clamp(16px,2.8vw,24px); margin-bottom:clamp(16px,2.8vw,24px);
      border:1px solid rgba(255,255,255,.08)}
    .form-title{font-size:clamp(1.25rem,2.3vw,1.6rem);font-weight:600;letter-spacing:.03em;margin-bottom:12px}

    /* Responsive grid */
    .form-layout{display:grid;grid-template-columns:360px 1fr;gap:clamp(16px,2.5vw,28px)}
    @media (max-width:1024px){.form-layout{grid-template-columns:320px 1fr}}
    @media (max-width:768px){.form-layout{grid-template-columns:1fr}}

    .left-panel{display:flex;flex-direction:column;gap:16px}
    .cover-upload{position:relative;background:#2a2a2d;border:2px dashed var(--line);
      border-radius:12px;padding:24px;min-height:300px;display:flex;flex-direction:column;
      align-items:center;justify-content:center;gap:8px;cursor:pointer;transition:border-color .2s, background .2s}
    .cover-upload:hover{border-color:var(--brand);background:#303033}
    .cover-upload.dragover{border-color:var(--brand);background:#1a1a1a}
    .upload-icon{width:60px;height:60px;border-radius:50%;background:#fff;color:#333;display:grid;place-items:center;font-size:1.5rem}
    .upload-text{font-weight:600}
    .upload-guidelines{color:#ccc;font-size:.92rem}
    .upload-dimensions{color:#999;font-size:.82rem}
    .camera-icon{position:absolute;right:16px;bottom:16px;width:40px;height:40px;border-radius:50%;background:#fff;color:#333;display:grid;place-items:center}

    .right-panel{display:flex;flex-direction:column;gap:16px}

    /* กล่องประกาศ: เอากรอบ/พื้นหลังออก เป็นข้อความล้วน */
    .content-warning,
    .categories-notice{
      background:none; border:none; padding:0; border-radius:0; color:#d8d8d8;
    }

    .form-group{display:flex;flex-direction:column;gap:8px}
    .form-label{font-weight:600}
    .form-input,.form-textarea,.category-select,.tags-input{
      width:100%;padding:14px;border:1px solid var(--line-soft);border-radius:10px;background:#444;color:#eee;font-size:1rem
    }
    .form-input:focus,.form-textarea:focus,.category-select:focus,.tags-input:focus{outline:none;border-color:var(--brand)}
    .form-textarea{min-height:120px;resize:vertical}

    .input-footer{display:flex;justify-content:space-between;align-items:center;margin-top:6px;gap:10px}
    .character-count{font-size:.9rem;color:#999}
    .input-actions{display:flex;gap:8px}
    .action-icon{width:28px;height:28px;border-radius:999px;background:var(--ok);color:#000;display:grid;place-items:center;font-size:.9rem;cursor:pointer;transition:.2s}
    .action-icon:hover{transform:scale(1.05)}

    /* นามปากกาแบบอ่านอย่างเดียว */
    .pen-name{display:flex;gap:12px;align-items:end}
    .pen-input[readonly]{background:#3a3a41; color:#ddd; cursor:not-allowed}
    .pen-btn{display:none} /* ปิดปุ่มจัดการ */

    .categories-title{font-size:1.1rem;margin-bottom:8px}

    /* Tags */
    .tags-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .tags-title{font-weight:600}
    .tags-count{color:#999}
    .tags-instruction{color:#ccc;font-size:.9rem;margin-top:6px}
    .tag-chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#3b3b3f;color:#eee;font-size:.92rem}
    .chip button{all:unset;cursor:pointer;background:#2b2b2f;border-radius:50%;width:20px;height:20px;display:grid;place-items:center;line-height:1.0}
    .chip button:hover{background:#222}

    .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:18px;flex-wrap:wrap}
    .btn{padding:12px 20px;border-radius:999px;border:1px solid #666;background:transparent;color:#fff;cursor:pointer}
    .btn:hover{background:#333}
    .btn.primary{background:#fff;color:#000;border-color:#fff}
    .btn.primary[disabled]{opacity:.6;cursor:not-allowed}
    .btn.primary:hover{filter:brightness(.94);transform:translateY(-1px)}

    .hidden{display:none}
    .msg{margin-top:10px;font-size:.95rem}.msg.error{color:var(--danger)}.msg.ok{color:var(--ok)}
  </style>
</head>
<body>
   <header>
  </header>

  <main class="main">
    <section class="panel">
      <h1 class="form-title">สร้างนิยายใหม่</h1>

      <div id="formMsg" class="msg" aria-live="polite"></div>

      <form id="novelForm" novalidate>
        <div class="form-layout">
          <!-- Left -->
          <div class="left-panel">
            <label class="form-label" for="coverFile" style="display:block;margin-bottom:6px">รูปปก</label>
            <div class="cover-upload" id="coverUpload" tabindex="0" role="button" aria-label="อัปโหลดรูปปก (รองรับ .jpg .png .webp)">
              <div class="upload-icon">⬆️</div>
              <div class="upload-text">อัปโหลดรูปปก</div>
              <div class="upload-guidelines">รองรับ .jpg .png .webp</div>
              <div class="upload-dimensions">(800×800 px)</div>
            </div>
            <input type="file" id="coverFile" class="hidden" accept=".jpg,.jpeg,.png,.webp">
          </div>

          <!-- Right -->
          <div class="right-panel">

            <p class="content-warning">*กรุณางดใช้ชื่อผลงานที่ไม่เหมาะสม หากพบเจอนิยายของท่านจะถูกลบจาก Platform โดยไม่แจ้งให้ทราบล่วงหน้า</p>

            <div class="form-group">
              <label for="title" class="form-label">ชื่อเรื่อง <span aria-hidden="true" style="color:#aaa;font-weight:500">(บังคับ)</span></label>
              <input class="form-input" type="text" id="title" name="title" maxlength="120" placeholder="ชื่อเรื่องของนิยาย" required>
              <div class="input-footer">
                <div class="character-count"><span id="titleCount">0</span>/120</div>
              </div>
            </div>

            <div class="form-group">
              <label for="synopsis" class="form-label">คำโปรย</label>
              <textarea class="form-textarea" id="synopsis" name="synopsis" maxlength="200" placeholder="คำโปรยหรือคำอธิบายสั้นๆ เกี่ยวกับนิยาย"></textarea>
              <div class="input-footer">
                <div class="character-count"><span id="synopsisCount">0</span>/200</div>
              </div>
            </div>

             <!-- นามปากกา: ใช้ username จาก backend แสดงอย่างเดียว -->
             <div class="form-group" style="margin-bottom: 24px;">
               <label for="penName" class="form-label">นามปากกา</label>
               <div class="pen-name">
                 <input class="form-input pen-input" type="text" id="penName" name="penName"
                        value="{{ username }}" readonly aria-readonly="true"
                        title="นามปากกาใช้ชื่อผู้ใช้ ไม่สามารถแก้ไขได้">
               </div>
             </div>
          </div>
        </div>

        <!-- Categories -->
        <div class="panel">
          <h2 class="categories-title">หมวดหมู่</h2>
          
          <div class="form-group">
            <!-- ช่องพิมพ์เพื่อค้นหา (datalist) -->
            <input class="form-input" id="cateSearch" list="categoriesList"
                   placeholder="พิมพ์เพื่อค้นหา เช่น Romance, Fantasy, ...">
        
            <!-- รายการหมวดจาก DB -->
            <datalist id="categoriesList">
              {% for c in categories %}
                <option value="{{ c.name }}" data-id="{{ c.cate_id }}"></option>
              {% endfor %}
            </datalist>
        
            <!-- เก็บค่า cate_id ที่เลือกไว้ (ให้ backend รับ field นี้) -->
            <input type="hidden" id="mainCategory" name="mainCategory">
            <small class="tags-instruction">ทางเราขอสงวนสิทธิ์ในการแก้ไขหมวดของงานเขียนให้สอดคล้องกับเนื้อหาโดยไม่จำเป็นต้องแจ้งให้ทราบล่วงหน้า</small>
          </div>
        </div>
        

        <!-- Tags -->
        <div class="panel">
          <div class="tags-header">
            <div class="tags-title">แท็ก</div>
            <span class="tags-count">(<span id="tagsCount">0</span>/19)</span>
          </div>
          <textarea id="tagsInput" class="tags-input" placeholder="ใส่แท็ก แนวนิยาย (กด Enter เพื่อเพิ่ม หรือคั่นหลายคำด้วยเครื่องหมายจุลภาค , )"></textarea>
          <div class="tag-chips" id="tagChips" aria-live="polite"></div>
          <div class="tags-instruction">คำแนะนำ: ใช้คำสั้น กระชับ เช่น &quot;มหาลัย, ไอดอล, ดราม่า&quot;</div>
        </div>

        <div class="actions">
          <button type="submit" class="btn primary" id="submitBtn">บันทึก</button>
        </div>
      </form>
    </section>
  </main>

  <script>
    // นับตัวอักษร
    function bindCounter(id, outId){
      const el = document.getElementById(id), out = document.getElementById(outId);
      const update = ()=>{ out.textContent = el.value.length; out.style.color = el.value.length>el.maxLength*0.85 ? '#ffaa00' : '#999' };
      el.addEventListener('input', update); update();
    }
    bindCounter('title','titleCount'); bindCounter('synopsis','synopsisCount');

    // อัปโหลดรูป (preview)
    const coverUpload=document.getElementById('coverUpload'), coverFile=document.getElementById('coverFile');
    function selectFile(file){
      if(!file.type.startsWith('image/')){alert('กรุณาเลือกไฟล์รูปภาพ');return}
      const reader=new FileReader();
      reader.onload=e=>{
        coverUpload.innerHTML=`<img src="${e.target.result}" alt="cover" style="max-width:100%;max-height:260px;border-radius:8px;display:block;margin-bottom:8px;"/><div class="upload-text" style="opacity:.9">รูปปกที่เลือก (ยังไม่อัปโหลด)</div>`;
      }; reader.readAsDataURL(file);
    }
    coverUpload.addEventListener('click',()=>coverFile.click());
    coverUpload.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();coverFile.click();}});
    coverUpload.addEventListener('dragover',e=>{e.preventDefault();coverUpload.classList.add('dragover')});
    coverUpload.addEventListener('dragleave',()=>coverUpload.classList.remove('dragover'));
    coverUpload.addEventListener('drop',e=>{e.preventDefault();coverUpload.classList.remove('dragover');if(e.dataTransfer.files.length) selectFile(e.dataTransfer.files[0])});
    coverFile.addEventListener('change',e=>{if(e.target.files.length) selectFile(e.target.files[0])});

    // === แท็ก (chips) ===
    const tagsInput=document.getElementById('tagsInput'), tagsCount=document.getElementById('tagsCount'), tagChips=document.getElementById('tagChips');
    let tags=[];

    function renderChips(){
      tagsCount.textContent=tags.length;
      tagChips.innerHTML='';
      tags.forEach((t,i)=>{
        const s=document.createElement('span');
        s.className='chip';
        s.innerHTML=`<span>${t}</span><button type="button" aria-label="ลบแท็ก ${t}" data-i="${i}" tabindex="0">✕</button>`;
        tagChips.appendChild(s);
      });
    }

    // ลบแท็ก (คลิกหรือกด Enter/Space)
    tagChips.addEventListener('click',e=>{
      const b=e.target.closest('button[data-i]'); if(!b) return;
      const i=Number(b.dataset.i);
      if(!Number.isNaN(i)){ tags.splice(i,1); renderChips(); }
    });
    tagChips.addEventListener('keydown',e=>{
      const b=e.target.closest('button[data-i]'); if(!b) return;
      if(e.key==='Enter' || e.key===' '){
        e.preventDefault();
        const i=Number(b.dataset.i);
        if(!Number.isNaN(i)){ tags.splice(i,1); renderChips(); }
      }
    });

    function hasTag(text){
      const lowered=text.toLowerCase();
      return tags.some(t=>t.toLowerCase()===lowered);
    }
    function addTag(text){
      const t=text.trim();
      if(!t) return;
      if(tags.length>=19){ alert('คุณใส่แท็กครบ 19 ข้อแล้ว'); return; }
      if(hasTag(t)) return;
      tags.push(t);
      renderChips();
    }

    // กด Enter / , (จุลภาค) / Tab เพื่อเพิ่มแท็กจากช่อง
    function tryCommitFromInput(){
      const v=tagsInput.value.trim();
      if(v){ addTag(v); tagsInput.value=''; }
    }
    tagsInput.addEventListener('keydown',e=>{
      if(e.key==='Enter' || e.key===',' || (e.key==='Tab' && tagsInput.value.trim())){
        e.preventDefault();
        // รองรับหลายคำคั่นด้วย ,
        const raw=tagsInput.value;
        if(raw.includes(',')){
          raw.split(',').map(s=>s.trim()).filter(Boolean).forEach(addTag);
          tagsInput.value='';
        }else{
          tryCommitFromInput();
        }
      }
    });
    // พิมพ์ , เพื่อแยกเป็นหลายแท็ก (ทันที)
    tagsInput.addEventListener('input',()=>{
      const raw=tagsInput.value;
      if(raw.includes(',')){
        raw.split(',').map(s=>s.trim()).filter(Boolean).forEach(addTag);
        tagsInput.value='';
      }
    });
    // อนุญาตวางข้อความคั่นด้วย ,
    tagsInput.addEventListener('paste',e=>{
      const text=(e.clipboardData||window.clipboardData).getData('text');
      if(!text) return;
      const parts=text.split(',').map(s=>s.trim()).filter(Boolean);
      if(parts.length>1){ e.preventDefault(); parts.forEach(addTag); }
    });
    // เมื่อออกจากช่อง ถ้ามีข้อความค้างอยู่ให้เพิ่มแท็ก
    tagsInput.addEventListener('blur',()=>{ tryCommitFromInput(); });

    // === ส่งข้อมูล ===
    const form=document.getElementById('novelForm'), msg=document.getElementById('formMsg'), submitBtn=document.getElementById('submitBtn');
    function setMsg(t,ok=false){ msg.textContent=t||''; msg.className='msg '+(ok?'ok':'error'); }
    form.addEventListener('submit',async(e)=>{
      e.preventDefault(); setMsg('');
      const title=document.getElementById('title').value.trim(); if(!title){ setMsg('กรุณากรอกชื่อเรื่อง'); return; }
      const payload={ title, synopsis:document.getElementById('synopsis').value||'', penName:document.getElementById('penName').value||'', mainCategory:document.getElementById('mainCategory').value||'', tags };

      submitBtn.disabled=true; submitBtn.textContent='กำลังบันทึก...';
      try{
        let resp, json={};
        const hasCover = coverFile && coverFile.files && coverFile.files.length>0;
        if(hasCover){
          // ถ้า backend รองรับไฟล์ ใช้ FormData (ชื่อ field: cover)
          const fd = new FormData();
          fd.append('title', payload.title);
          fd.append('synopsis', payload.synopsis);
          fd.append('penName', payload.penName);
          fd.append('mainCategory', payload.mainCategory);
          fd.append('tags', JSON.stringify(payload.tags));
          fd.append('cover', coverFile.files[0]);
          resp = await fetch('/api/novels',{ method:'POST', body: fd });
        }else{
          // เดิม: ส่ง JSON ปกติ
          resp = await fetch('/api/novels',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        }
        json=await resp.json().catch(()=>({}));
        if(!resp.ok || !json.ok) throw new Error(json.error||'บันทึกไม่สำเร็จ');
        setMsg('สร้างนิยายใหม่เรียบร้อย!',true); window.location.href=`/novels/${json.novels_id}`;
      }catch(err){ setMsg(err.message||'เกิดข้อผิดพลาด'); }
      finally{ submitBtn.disabled=false; submitBtn.textContent='บันทึก'; }
    });

     // --- sync mainCategory (cate_id) จาก datalist ---
     const cateInput  = document.getElementById('cateSearch');
     const cateHidden = document.getElementById('mainCategory');
     const cateList   = document.getElementById('categoriesList');
 
     function syncCategoryId(){
       const v = (cateInput.value || '').trim().toLowerCase();
       let id = '';
       if (v) {
         const opt = Array.from(cateList.options).find(o => o.value.toLowerCase() === v);
         if (opt) id = opt.dataset.id || opt.getAttribute('data-id');
       }
       cateHidden.value = id; // ว่างถ้ายังไม่เลือกตรงกับรายการ
     }
     cateInput.addEventListener('input',  syncCategoryId);
     cateInput.addEventListener('change', syncCategoryId);
     
 
  </script>
</body>
</html>
