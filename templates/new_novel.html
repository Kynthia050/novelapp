<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>สร้างนิยายใหม่ — MYSHELF</title>

  <!-- Tailwind (ใช้ config แบบเดียวกับ edit_novel) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg:    '#111214',
            panel: '#18191b',
            line:  '#27282c',
            text:  '#e5e7eb',
            muted: '#9ca3af',
            brand: '#d4d4d8'
          },
          borderRadius: { '2xl': '16px' }
        }
      }
    }
  </script>

  <style>
    :root {
      --bg:#111214;
      --panel:#18191b;
      --line:#27282c;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --radius:16px;
      --card:#18191b;
      --chip:rgba(255,255,255,.04);
      --accent:#f3f4f6;
      --shadow:0 18px 45px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: var(--bg);
      color:var(--text);
    }

    .site{
      max-width:1100px;
      margin:0 auto;
      padding:20px;
    }
    .panel{
      background:rgba(24,25,27,.96);
      border:1px solid var(--line);
      border-radius:var(--radius);
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:.5rem;
    }
    .btn-primary{
      background:#f3f4f6;
      color:#111827;
      border:1px solid #d1d5db;
    }
    .btn-ghost{
      background:transparent;
      border:1px solid var(--line);
      color:var(--text);
    }
    .btn-dark{
      background:#0f0f10;
      border:1px solid #2b2c30;
      color:#e5e7eb;
    }
    .btn:disabled{
      opacity:.5;
      pointer-events:none;
    }

    .input,
    .select,
    .textarea{
      width:100%;
      padding:.65rem .8rem;
      border:1px solid var(--line);
      border-radius:12px;
      background:#0f1012;
      color:var(--text);
      outline:none;
      font-size:.95rem;
    }
    .textarea-description{
      min-height: 170px;
      max-height: 170px;
      resize: none;
    }
    .input:focus,
    .select:focus,
    .textarea:focus{
      outline:none;
      box-shadow:0 0 0 1px #4b5563;
    }

    /* select ลูกศรแบบ edit_novel */
    .select{
      appearance:none;
      background-image:url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2212%22 height=%228%22 viewBox=%220 0 12 8%22%3E%3Cpath fill=%22%23a1a1aa%22 d=%22M6 8L0 0h12z%22/%3E%3C/svg%3E');
      background-repeat:no-repeat;
      background-position:right .8rem center;
      background-size:12px 8px;
    }

    /* กล่องอัปโหลดปกแบบเดียวกับ edit_novel */
    .cover-upload{
      width:min(320px, 90vw);
      height:min(320px, 90vw);
      border:2px dashed var(--line);
      border-radius:16px;
      background:#0f1012;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      cursor:pointer;
      text-align:center;
      padding:12px;
    }
    .cover-upload:focus{
      outline:2px dashed #4b5563;
      outline-offset:2px;
    }
    .cover-upload img{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:16px;
      display:block;
    }
    .upload-icon{opacity:.85;font-size:26px}
    .upload-text{color:var(--text)}
    .upload-guidelines,
    .upload-dimensions{
      color:var(--muted);
      font-size:12px;
    }

    /* แท็ก */
    .chip{
      display:inline-flex;
      align-items:center;
      gap:.5rem;
      padding:.35rem .6rem;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(255,255,255,.03);
      font-size:.8rem;
    }
    .chip button{
      opacity:.7;
      cursor:pointer;
    }
    .chip button:hover{opacity:1}

    .hidden{display:none}

    .msg{
      font-size:.9rem;
      min-height:1.1em;
    }
    .msg-error{color:#f87171;}
    .msg-ok{color:#4ade80;}
  </style>
</head>
<body>

  <!-- Header แบบเดียวกับ edit_novel -->
  <header >
  </header>

  <main class="site">
    <!-- ฟอร์มสร้างนิยายใหม่ ใช้ดีไซน์ panel เดียวกับ edit_novel -->
    <form id="novelForm" class="panel p-5 md:p-6 space-y-6" novalidate>
      <div class="flex items-center justify-between gap-3 mb-2">
        <h1 class="text-lg md:text-xl font-semibold tracking-wide">
          สร้างนิยายใหม่
        </h1>
      </div>

      <p id="formMsg" class="msg"></p>

      <!-- Cover + Meta -->
      <div class="grid md:grid-cols-[320px_1fr] gap-5 items-start">
        <!-- LEFT: Cover -->
        <div class="space-y-3">
          <label class="block text-sm text-[var(--muted)] mb-1" for="coverInput">
            รูปปก
          </label>
          <div
            id="coverUpload"
            class="cover-upload"
            tabindex="0"
            role="button"
            aria-label="อัปโหลดรูปปก (รองรับ .jpg .png .webp)">
            <div class="upload-icon">⬆️</div>
            <div class="upload-text">อัปโหลดรูปปก</div>
            <div class="upload-guidelines">รองรับ .jpg .png .webp</div>
            <div class="upload-dimensions">(800×800 px)</div>
          </div>
          <input
            id="coverInput"
            type="file"
            accept=".jpg,.jpeg,.png,.webp"
            class="hidden" />
        </div>

        <!-- RIGHT: ข้อมูลนิยาย -->
        <div class="grid gap-4">
          <!-- ชื่อเรื่อง -->
          <div>
            <label class="block text-sm text-[var(--muted)] mb-1" for="title">
              ชื่อเรื่อง <span class="text-xs text-[var(--muted)]">(บังคับ)</span>
            </label>
            <input
              id="title"
              name="title"
              maxlength="120"
              required
              class="input"
              placeholder="ใส่ชื่อเรื่องของนิยาย" />
            <p class="mt-1 text-xs text-[var(--muted)] text-right">
              <span id="titleCount">0</span>/120
            </p>
          </div>

          <!-- นามปากกา (ใช้ username) -->
          <div>
            <label class="block text-sm text-[var(--muted)] mb-1" for="penName">
              นามปากกา
            </label>
            <input
              id="penName"
              name="penName"
              class="input bg-[#0f1012] cursor-not-allowed"
              value="{{ username }}"
              readonly
              aria-readonly="true"
              title="นามปากกาใช้ชื่อผู้ใช้ ไม่สามารถแก้ไขได้" />
          </div>

          <!-- หมวดหมู่ -->
          <div>
            <label class="block text-sm text-[var(--muted)] mb-1" for="mainCategory">
              หมวดหมู่
            </label>
            <select
              id="mainCategory"
              name="mainCategory"
              class="select"
              required>
              <option value="">— เลือกหมวดหมู่ —</option>
              {% for c in categories %}
                <option value="{{ c.cate_id }}">{{ c.name }}</option>
              {% endfor %}
            </select>
            <p class="mt-1 text-xs text-[var(--muted)]">
              ทางเราขอสงวนสิทธิ์ในการแก้ไขหมวดของงานเขียนให้สอดคล้องกับเนื้อหาโดยไม่จำเป็นต้องแจ้งให้ทราบล่วงหน้า
            </p>
          </div>

          <!-- คำโปรย -->
          <div>
            <label class="block text-sm text-[var(--muted)] mb-1" for="synopsis">
              คำโปรย
            </label>
            <textarea
              id="synopsis"
              name="synopsis"
              maxlength="200"
              class="textarea textarea-description"
              placeholder="คำโปรยหรือคำอธิบายสั้นๆ เกี่ยวกับนิยาย (ไม่เกิน 200 ตัวอักษร)"
            ></textarea>
            <p class="mt-1 text-xs text-[var(--muted)] text-right">
              <span id="synopsisCount">0</span>/1000
            </p>
          </div>
        </div>
      </div>

      <!-- TAGS PANEL (สไตล์คล้ายส่วนแท็กใน edit_novel) -->
      <section class="panel p-4 md:p-5 mt-4 space-y-3">
        <div class="flex items-center justify-between mb-1">
          <h2 class="font-semibold tracking-wide text-sm md:text-base">
            แท็กของนิยาย
          </h2>
          <div class="text-xs text-[var(--muted)]">
            (<span id="tagsCount">0</span>/20)
          </div>
        </div>

        <div id="tagChips" class="flex flex-wrap gap-2 mb-2"></div>

        <div class="flex gap-2">
          <input
            id="tagsInput"
            class="input"
            placeholder="พิมพ์แท็ก แล้วกด Enter หรือใส่หลายคำคั่นด้วย , " />
          <button
            id="addTagBtn"
            type="button"
            class="btn btn-dark px-4 py-2 rounded-xl text-sm">
            เพิ่ม
          </button>
        </div>

        <p class="mt-1 text-xs text-[var(--muted)]">
          ตัวอย่าง: <span class="opacity-90">มหาลัย, ไอดอล, ดราม่า</span>
        </p>
      </section>

      <!-- Actions -->
      <div class="flex justify-end gap-3 pt-2">
        <button
          type="submit"
          id="submitBtn"
          class="btn btn-primary px-5 py-2 rounded-full font-semibold text-sm">
          สร้างนิยาย
        </button>
      </div>
    </form>
  </main>

  <script>
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';

    // ===== นับตัวอักษร title / synopsis =====
    function bindCounter(inputId, counterId){
      const el  = document.getElementById(inputId);
      const out = document.getElementById(counterId);
      if(!el || !out) return;
      const update = () => {
        const len = el.value.length;
        out.textContent = len;
      };
      el.addEventListener('input', update);
      update();
    }
    bindCounter('title','titleCount');
    bindCounter('synopsis','synopsisCount');

    // ===== อัปโหลด/พรีวิวรูปปก (แบบเดียวกับ edit_novel) =====
    const coverUpload = document.getElementById('coverUpload');
    const coverInput  = document.getElementById('coverInput');

    function openCoverPicker(){
      coverInput?.click();
    }

    function previewCover(file){
      if(!file) return;
      if(!file.type || !file.type.startsWith('image/')){
        alert('กรุณาเลือกไฟล์รูปภาพ');
        return;
      }
      const reader = new FileReader();
      reader.onload = (ev) => {
        coverUpload.innerHTML = `<img src="${ev.target.result}" alt="ปกนิยายที่เลือก">`;
      };
      reader.readAsDataURL(file);
    }

    coverUpload?.addEventListener('click', openCoverPicker);
    coverUpload?.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' || e.key === ' '){
        e.preventDefault();
        openCoverPicker();
      }
    });
    coverInput?.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      previewCover(file);
    });

    // ===== ระบบแท็ก (chips) =====
    const tagsInput = document.getElementById('tagsInput');
    const tagChips  = document.getElementById('tagChips');
    const tagsCount = document.getElementById('tagsCount');
    const addTagBtn = document.getElementById('addTagBtn');
    let tags = [];

    function renderTags(){
      tagChips.innerHTML = '';
      tagsCount.textContent = tags.length;
      tags.forEach((t, i) => {
        const span = document.createElement('span');
        span.className = 'chip';
        span.innerHTML =
          `<span>${t}</span>`+
          `<button type="button" data-i="${i}" aria-label="ลบแท็ก ${t}">×</button>`;
        tagChips.appendChild(span);
      });
    }
    function hasTag(text){
      const lower = text.toLowerCase();
      return tags.some(t => t.toLowerCase() === lower);
    }
    function addTag(text){
      const t = (text || '').trim();
      if(!t) return;
      if(tags.length >= 19){
        alert('คุณใส่แท็กครบ 20 แล้ว');
        return;
      }
      if(hasTag(t)) return;
      tags.push(t);
      renderTags();
    }
    function commitFromInput(){
      const raw = (tagsInput.value || '').trim();
      if(!raw) return;
      if(raw.includes(',')){
        raw.split(',')
           .map(s => s.trim())
           .filter(Boolean)
           .forEach(addTag);
      }else{
        addTag(raw);
      }
      tagsInput.value = '';
    }

    addTagBtn?.addEventListener('click', () => {
      commitFromInput();
    });

    tagsInput?.addEventListener('keydown', (e) => {
      if(e.key === 'Enter' || e.key === ',' || (e.key === 'Tab' && tagsInput.value.trim())){
        e.preventDefault();
        commitFromInput();
      }
    });
    tagsInput?.addEventListener('input', () => {
      const raw = tagsInput.value;
      if(raw.includes(',')){
        commitFromInput();
      }
    });
    tagsInput?.addEventListener('paste', (e) => {
      const text = (e.clipboardData || window.clipboardData).getData('text');
      if(!text) return;
      const parts = text.split(',').map(s => s.trim()).filter(Boolean);
      if(parts.length > 1){
        e.preventDefault();
        parts.forEach(addTag);
      }
    });

    tagChips?.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-i]');
      if(!btn) return;
      const i = Number(btn.dataset.i);
      if(!Number.isNaN(i)){
        tags.splice(i,1);
        renderTags();
      }
    });

    // ===== ส่งข้อมูลไป /api/novels ของ new_novel blueprint =====
    const form      = document.getElementById('novelForm');
    const formMsg   = document.getElementById('formMsg');
    const submitBtn = document.getElementById('submitBtn');

    const apiCreateUrl   = "{{ url_for('new_novel.api_create_novel') }}";
    const viewUrlTemplate = "{{ url_for('new_novel.view_novel', novels_id=0) }}"; // '/novels/0'

    function setMsg(text, ok=false){
      formMsg.textContent = text || '';
      formMsg.className   = 'msg ' + (ok ? 'msg-ok' : 'msg-error');
    }

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      setMsg('');

      const titleEl       = document.getElementById('title');
      const synopsisEl    = document.getElementById('synopsis');
      const mainCategoryEl= document.getElementById('mainCategory');
      const penNameEl     = document.getElementById('penName');

      const title   = (titleEl.value || '').trim();
      const synopsis= synopsisEl.value || '';
      const mainCat = (mainCategoryEl.value || '').trim();
      const penName = penNameEl?.value || '';

      if(!title){
        setMsg('กรุณากรอกชื่อเรื่อง');
        titleEl.focus();
        return;
      }
      if(!mainCat){
        setMsg('กรุณาเลือกหมวดหมู่');
        mainCategoryEl.focus();
        return;
      }

      const payload = {
        title,
        synopsis,
        penName,
        mainCategory: mainCat,
        tags: tags.slice()
      };

      submitBtn.disabled = true;
      submitBtn.textContent = 'กำลังบันทึก...';

      try{
        let resp;
        const file = coverInput?.files && coverInput.files[0];
        if(file){
          const fd = new FormData();
          fd.append('title', payload.title);
          fd.append('synopsis', payload.synopsis);
          fd.append('penName', payload.penName);
          fd.append('mainCategory', payload.mainCategory);
          fd.append('tags', JSON.stringify(payload.tags));
          fd.append('cover', file);

          resp = await fetch(apiCreateUrl, {
            method:'POST',
            headers:{ 'X-CSRFToken': csrfToken },
            body: fd
          });
        }else{
          resp = await fetch(apiCreateUrl, {
            method:'POST',
            headers:{
              'Content-Type':'application/json',
              'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(payload)
          });
        }

        const json = await resp.json().catch(() => ({}));
        if(!resp.ok || !json.ok){
          throw new Error(json.error || 'บันทึกไม่สำเร็จ');
        }

        setMsg('สร้างนิยายใหม่เรียบร้อย!', true);

        const viewUrl = viewUrlTemplate.replace('0', json.novels_id);
        window.location.href = viewUrl;

      }catch(err){
        setMsg(err.message || 'เกิดข้อผิดพลาด');
      }finally{
        submitBtn.disabled = false;
        submitBtn.textContent = 'สร้างนิยาย';
      }
    });
  </script>
</body>
</html>
