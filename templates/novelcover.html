<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ novel.title }} ‚Äî Myshelf</title>
  <style>
    :root{
  --bg:#1f1f21; --panel:#232326; --text:#f3f3f3; --muted:#c7c7cc; --accent:#e7e7ea;
  --card:#2a2a2d; --radius:16px; --shadow:0 4px 12px rgba(0,0,0,.35);
  --chip:#2f2f33; --chip-on:#3a3a40; --brand:#fff;
  --star:#ffd76a;  
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--text);
      font-family: "Georgia", serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial;
      line-height:1.6;
    }
    .site{max-width:1200px;margin-inline:auto;padding-inline:clamp(16px, 4vw, 28px);}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg, rgba(31,31,33,.98), rgba(31,31,33,.95));backdrop-filter: blur(6px);border-bottom:1px solid rgba(255,255,255,.06);}
    .navbar{display:flex;align-items:center;gap:16px;padding:14px 0}
    .brand{letter-spacing:.25em;font-weight:700}
    .brand, .brand span{font-size:clamp(16px, 2.6vw, 28px)}
    .brand img{height:clamp(40px, 5vw, 72px);width:auto;object-fit:contain}

    .nav-actions{margin-left:auto;display:flex;align-items:center;gap:10px}
    .search{position:relative;min-width:min(40vw, 280px)}
    .search input{width:100%;padding:8px 32px 8px 12px;border:1px solid rgba(255,255,255,.12);border-radius:999px;background:#111214;color:var(--text);outline:none;}
    .search button{position:absolute;right:4px;top:50%;transform:translateY(-50%);border:0;background:transparent;color:var(--muted);width:32px;height:32px;border-radius:50%;display:grid;place-items:center;cursor:pointer}
    .icon-btn{width:36px;height:36px;border-radius:50%;border:1px solid rgba(255,255,255,.12);background:#111214;color:var(--muted);display:grid;place-items:center;cursor:pointer;font-size:18px}

    section{padding:28px 0}
    h1{font-size:clamp(24px, 3vw, 36px);letter-spacing:.15em;margin:0 0 16px 0;font-weight:700}
    h2{font-size:clamp(18px, 2vw, 24px);letter-spacing:.15em;margin:0 0 16px 0;font-weight:700}

    .novel-header{display:grid;grid-template-columns: 300px 1fr;gap:32px;margin-bottom:16px}
    .cover-image{width:100%;aspect-ratio:6/6;object-fit:cover;border-radius:var(--radius);box-shadow:var(--shadow)}
    .novel-info h1{margin-top:0}
    .novel-meta{display:flex;flex-wrap:wrap;gap:12px;margin:16px 0}
    .meta-item{background:var(--chip);padding:8px 16px;border-radius:999px;font-size:14px}
    .novel-description{color:var(--muted);line-height:1.7;margin:16px 0}

    /* ===================== NOVEL DETAIL (REACT-LIKE UI) ===================== */

  .main-header-space{
    padding:28px 0 0;
  }

  /* ‡∏Å‡∏£‡∏¥‡∏î‡∏´‡∏•‡∏±‡∏Å: ‡∏õ‡∏Å + ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î */
  .novel-header{
    display:grid;
    grid-template-columns:minmax(260px, 320px) minmax(0, 1fr);
    gap:32px;
    margin-bottom:32px;
    align-items:flex-start;
  }

  /* ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡∏õ‡∏Å + ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô */
  .novel-left{
    display:flex;
    flex-direction:column;
    gap:16px;
  }

  /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô */
.rating-card{
  background:var(--card);
  border-radius:24px;
  padding:10px 20px 14px;
  box-shadow:var(--shadow);
  border:1px solid rgba(255,255,255,.08);
}

/* ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô: "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢" + ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç */
.rating-card-top{
  display:flex;
  justify-content:space-between;
  align-items:baseline;
  margin-bottom:4px;
}

.rating-card-header{
  font-size:.85rem;
  letter-spacing:.1em;
  text-transform:uppercase;
  color:var(--muted);
}

/* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ */
.rating-card-score{
  display:flex;
  align-items:baseline;
  gap:4px;
}

.rating-score-main{
  font-size:2.4rem;
  font-weight:700;
  color:var(--star);   /* ‡πÉ‡∏´‡πâ‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏™‡∏µ‡∏î‡∏≤‡∏ß */
}

.rating-score-max{
  font-size:1rem;
  color:var(--muted);
}

/* ‡∏î‡∏≤‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô */
.rating-card-stars{
  margin:2px 0 6px;
  display:flex;              /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô flex container */
  justify-content:center;    /* ‡∏à‡∏±‡∏î‡∏•‡∏π‡∏Å (‡∏î‡∏≤‡∏ß) ‡πÉ‡∏´‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
}

.star-rating{
  display:inline-flex;
  flex-direction:row-reverse;   /* ‡πÉ‡∏´‡πâ hover ‡πÑ‡∏•‡πà‡∏à‡∏≤‡∏Å‡∏Ç‡∏ß‡∏≤‡πÑ‡∏õ‡∏ã‡πâ‡∏≤‡∏¢ */
  gap:4px;
}

.star-rating input{
  display:none;
}

.star-rating label{
  cursor:pointer;
  font-size:22px;
  color:rgba(255,255,255,.18);
  transition:color .15s ease, transform .15s ease;
  text-shadow:0 0 8px rgba(0,0,0,.4);
}

/* hover */
.star-rating label:hover,
.star-rating label:hover ~ label{
  color:var(--star);
  transform:translateY(-1px);
}

/* checked (‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å) */
.star-rating input:checked ~ label{
  color:var(--star);
}

/* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô */
.rating-card-footer{
  display:flex;
  flex-direction:column;
  gap:2px;
  align-items:center;
  text-align:center;
}

.rating-count{
  font-size:.8rem;
  color:var(--muted);
}

.rating-hint{
  font-size:.75rem;
  color:var(--muted);
  opacity:.85;
}



  /* ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢ */
  .novel-main{
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .novel-title{
    font-size:clamp(26px, 3vw, 36px);
    font-weight:700;
    letter-spacing:.05em;
    margin:0;
  }

  .novel-author-line{
    font-size:.95rem;
    color:var(--muted);
  }

  .novel-author{
    font-weight:600;
    color:var(--accent);
  }

  .novel-submeta{
    font-size:.85rem;
    color:var(--muted);
    margin-top:2px;
  }

  /* ‡πÅ‡∏ó‡πá‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ */
  .tag-list{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    margin-top:12px;
  }

  .tag-pill{
    background:var(--chip);
    padding:8px 14px;
    border-radius:999px;
    font-size:.85rem;
  }

  /* ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥: ‡∏ú‡∏π‡πâ‡∏≠‡πà‡∏≤‡∏ô / ‡∏ï‡∏≠‡∏ô / ‡∏Å‡∏î‡∏ñ‡∏π‡∏Å‡πÉ‡∏à */
  .novel-stats{
    display:flex;
    flex-wrap:wrap;
    gap:18px;
    margin-top:10px;
    font-size:.9rem;
    color:var(--muted);
  }

  .stat-item{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:.9rem;
}

.stat-icon{
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

.stat-icon svg{
  width:18px;
  height:18px;
  display:block;
}


  /* ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠ */
  .novel-description-block{
    margin-top:14px;
  }

  .section-heading{
    font-size:1rem;
    font-weight:700;
    margin:0 0 6px;
  }

  .novel-description{
    margin:0;
    color:var(--muted);
    line-height:1.7;
  }

  /* ‡∏õ‡∏∏‡πà‡∏° action */
  .novel-actions{
    display:flex;
    flex-wrap:wrap;
    gap:12px;
    margin-top:18px;
  }

  .btn-lg{
  border-radius:999px;
  padding:10px 22px;
  font-size:.95rem;
  border:1px solid rgba(255,255,255,.16);
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:6px;
  background:transparent;
  color:var(--text);
  text-decoration:none;
  transition:background-color .18s ease, color .18s ease;
}
/* ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏•‡∏±‡∏Å */

/* icon ‡πÉ‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà */
.btn-icon{
  display:inline-flex;
  align-items:center;
  justify-content:center;
}

.btn-icon svg{
  width:18px;
  height:18px;
  display:block;
  stroke:currentColor; /* ‡πÉ‡∏´‡πâ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
  fill:none;
  stroke-width:1.7;
}


/* hover ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏ö */
.btn-lg:hover,
.btn-lg:focus,
.btn-lg-primary:hover,
.btn-lg-ghost:hover,
.bookshelf-btn--active{
  text-decoration:none;
  background:#ffffff;   /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏Ç‡∏≤‡∏ß */
  color:#000000;        /* ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏î‡∏≥ */
}

  .bookshelf-btn {
    transition: background .15s ease, color .15s ease, transform .1s ease;
  }


  .bookshelf-btn--active:hover {
    transform: translateY(-1px);
  }

  .bookshelf-btn--active svg {
    fill: currentColor;
  }

  /* mobile */
  @media (max-width:768px){
    .novel-header{
      grid-template-columns:1fr;
      gap:20px;
    }
    .cover-card{
      max-width:320px;
      margin:0 auto;
    }
  }



       /* --------- CHAPTER LIST (‡πÅ‡∏ö‡∏ö Accordion 1‚Äì50, 51‚Äì100 ...) ---------- */

    .chapters-section{
      margin-top:32px;
    }

    .chapters-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }

    .chapters-heading{
      font-size:clamp(18px, 2vw, 24px);
      letter-spacing:.15em;
      margin:0;
      font-weight:700;
    }

    /* ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á */
    .chapters-sort-toggle{
      border-radius:999px;
      padding:6px 14px;
      font-size:.85rem;
      background:var(--chip);
      border:1px solid rgba(255,255,255,.16);
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .chapters-sort-toggle:hover{
      background:rgba(255,255,255,.12);
    }
    .chapters-sort-toggle.desc{
      background:var(--accent);
      color:#111214;
    }
    .chapters-sort-label{
      white-space:nowrap;
    }
    .chapters-sort-icon{
      font-size:.7rem;
      transition:transform .15s ease;
    }
    .chapters-sort-toggle.desc .chapters-sort-icon{
      transform:rotate(180deg);
    }

    /* ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≠‡∏ô */
    .chapters-accordion{
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .chapter-group{
      background:var(--card);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.16);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    /* ‡∏´‡∏±‡∏ß‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡πà‡∏ß‡∏á‡∏ï‡∏≠‡∏ô (‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1-50, 51-100 ...) */
    .chapter-group-header{
      width:100%;
      padding:14px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background:rgba(0,0,0,.12);
      border:none;
      cursor:pointer;
      color:var(--text);
      font-size:.9rem;
    }

    .chapter-group-title{
      font-weight:600;
      letter-spacing:.03em;
    }

    .chapter-group-meta{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:.85rem;
      color:var(--muted);
    }

    .chapter-group-count{
      opacity:.9;
    }

    .chapter-group-caret{
      font-size:.75rem;
      display:inline-flex;
      align-items:center;
      transition:transform .15s ease;
    }

    /* ‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà class is-open ‡∏ó‡∏µ‡πà .chapter-group */
    .chapter-group.is-open .chapter-group-caret{
      transform:rotate(180deg);
    }

    /* ‡∏ï‡∏±‡∏ß‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á */
    .chapter-group-body{
      border-top:1px solid rgba(255,255,255,.16);
      background:var(--card);
    }

    /* ‡∏ã‡πà‡∏≠‡∏ô body ‡∏ñ‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏µ is-open */
    .chapter-group:not(.is-open) .chapter-group-body{
      display:none;
    }


    /* list ‡∏ï‡∏≠‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á */
    .chapters-list{
      margin:0;
      padding:0;
      list-style:none;
    }

    .chapter-row{
      padding:12px 20px;
      border-bottom:1px solid rgba(255,255,255,.12);
      transition:background .15s ease;
    }
    .chapter-row:last-child{
      border-bottom:none;
    }
    .chapter-row:hover{
      background:rgba(255,255,255,.03);
    }

    .chapter-row-inner{
      display:flex;
      align-items:center;
      gap:12px;
    }

    /* ‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢: ‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà X + ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ô (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏£‡∏π‡∏õ) */
    .chapter-main{
      flex:1;
      display:flex;
      align-items:center;
      gap:20px;
      text-decoration:none;
      color:var(--text);
    }
    .chapter-main:visited{
      color:var(--text);
    }

    .chapter-label{          /* ‚Äú‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1‚Äù */
      font-size:.85rem;
      color:var(--muted);
      white-space:nowrap;
    }
    .chapter-title{          /* ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ô */
      font-size:.95rem;
      font-weight:500;
    }

    /* ‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏±‡∏ß‡πÉ‡∏à + ‡∏¢‡∏≠‡∏î‡πÑ‡∏•‡∏Å‡πå */
    .chapter-meta{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:12px;
      font-size:.85rem;
      color:var(--muted);
      white-space:nowrap;
    }


    .chapter-date{
      white-space:nowrap;
    }

    .chapter-like-btn{
      display:inline-flex;
      align-items:center;
      gap:4px;
      border:none;
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      padding:4px 8px;
      border-radius:999px;
      transition:background .15s ease, color .15s ease;
    }

    .chapter-like-btn .heart-icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }

    .chapter-like-btn .heart-icon svg{
      width:16px;
      height:16px;
      display:block;
    }

    .chapter-like-btn:hover{
      background:rgba(255,255,255,.08);
    }

    .chapter-like-btn.liked{
      color:var(--muted); /* ‡πÉ‡∏´‡πâ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° */
    }

    .chapter-like-btn.liked .heart-icon svg{
      fill:#ff4b5c;
    }

    /* ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏±‡∏ß‡∏Å‡∏•‡πà‡∏≠‡∏á + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≠‡∏ô + ‡∏¢‡∏≠‡∏î‡πÑ‡∏•‡∏Å‡πå */
    .chapter-group-title,
    .chapter-group-count,
    .chapter-like-btn .like-count {
      font-family:"Georgia", serif, -apple-system, BlinkMacSystemFont,
              "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }


    @media(max-width:600px){
      .chapter-row-inner{
        flex-direction:column;
        align-items:flex-start;
      }
      .chapter-meta{
        width:100%;
        justify-content:space-between;
        font-size:.8rem;
      }
    }


    /* ---------------- COMMENTS UI ---------------- */

    .comments-wrap{
      margin-top:8px;
      padding:28px 0 40px;
      border-top:1px solid rgba(255,255,255,.08);
      position:relative;
      overflow:hidden;
    }
    .comment-form{
      margin-bottom:24px;
      background:var(--card);
      border-radius:var(--radius);
      padding:16px 18px 14px;
      border:1px solid rgba(255,255,255,.06);
      box-shadow:var(--shadow);
    }
    .comment-form textarea{
      width:100%;
      min-height:96px;
      resize:vertical;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:#111214;
      color:var(--text);
      padding:10px 12px;
      font-family:inherit;
      font-size:14px;
      outline:none;
    }
    .comment-form textarea::placeholder{
      color:rgba(199,199,204,.8);
    }
    .comment-form textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(255,255,255,.16);
    }
    .comment-form-footer{
      margin-top:8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .char-count{
      font-size:12px;
      color:var(--muted);
    }
    .comment-submit-btn{
      border:0;
      border-radius:999px;
      padding:8px 18px;
      font-size:14px;
      font-weight:600;
      letter-spacing:.05em;
      text-transform:uppercase;
      background:var(--accent);
      color:#111214;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
      transition:transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .comment-submit-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 24px rgba(0,0,0,.45);
    }
    .comment-submit-btn:active{
      transform:translateY(0);
      box-shadow:0 4px 14px rgba(0,0,0,.3);
    }

        /* ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô */
    .summary-helper-wrap{
      margin:16px 0 28px;
      display:flex;
      justify-content:center;
    }
    .summary-helper-btn{
      border-radius:999px;
      padding:8px 20px;
      font-size:15px;
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
      background:transparent;
      color:var(--accent);
      border:1px solid rgba(255, 255, 255, 0.28);
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow:0 4px 14px rgba(253, 253, 253, 0.35);
      transition:background .15s ease,color .15s ease,
                 transform .15s ease,box-shadow .15s ease,border-color .15s ease;
    }
    .summary-helper-btn::before{
      content:"‚ú®";
      font-size:14px;
    }
    .summary-helper-btn:hover{
      background:var(--accent);
      color:#111214;
      transform:translateY(-1px);
      border-color:transparent;
      box-shadow:0 8px 22px rgba(0,0,0,.5);
    }
    .summary-helper-btn:active{
      transform:translateY(0);
      box-shadow:0 4px 14px rgba(0,0,0,.3);
    }

    /* SUMMARY MODAL */
    .summary-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:999;
    }
    .summary-modal.active{
      display:flex;
    }
    .summary-modal-overlay{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.65);
      backdrop-filter:blur(4px);
    }
    .summary-modal-dialog{
      position:relative;
      max-width:520px;
      width:calc(100% - 40px);
      background:var(--card);
      padding:20px 22px 18px;
      border-radius:20px;
      border:1px solid rgba(255,255,255,.18);
      box-shadow:0 18px 36px rgba(0,0,0,.6);
      z-index:1;
    }
    .summary-modal-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .summary-modal-title{
      margin:0;
      font-size:18px;
      letter-spacing:.08em;
    }
    .summary-modal-close{
      border:0;
      background:transparent;
      color:var(--muted);
      font-size:20px;
      cursor:pointer;
      border-radius:999px;
      width:32px;
      height:32px;
      display:grid;
      place-items:center;
      transition:background .15s ease,color .15s ease,transform .15s ease;
    }
    .summary-modal-close:hover{
      background:rgba(255,255,255,.08);
      color:var(--accent);
      transform:rotate(6deg);
    }
    .summary-modal-body{
      font-size:14px;
      color:var(--muted);
      line-height:1.7;
    }


    .comments-header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:16px;
      margin-bottom:6px;
    }
    .comments-header-main h2{
      margin:0;
    }
    .comments-controls{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .comments-btn{
      width:32px;
      height:32px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:#111214;
      color:var(--muted);
      display:grid;
      place-items:center;
      cursor:pointer;
      font-size:14px;
      transition:background .15s ease, color .15s ease, transform .15s ease;
    }
    .comments-btn:hover{
      background:var(--accent);
      color:#000;
      transform:translateY(-1px);
    }

    .comments-track{
      display:flex;
      gap:20px;
      overflow-x:auto;
      scroll-snap-type:x mandatory;
      padding:12px 4px 4px;
      -ms-overflow-style:none;
      scrollbar-width:none;
    }
    .comments-track::-webkit-scrollbar{display:none;}

    .comment-card{
      min-width:min(360px, 100%);
      scroll-snap-align:center;
      display:flex;
      flex-direction:column;
      align-items:flex-start;
      gap:12px;
      opacity:0;
      transform:translateY(18px) scale(.98);
      transition:opacity .6s ease, transform .6s ease;
    }
    .comment-card.show{
      opacity:1;
      transform:none;
    }
    .comment-bubble{
      position:relative;
      background:var(--card);
      border-radius:18px;
      padding:18px 20px 20px;
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.06);
      transform-style:preserve-3d;
      transition:transform .18s ease-out, box-shadow .18s ease-out;
      width:100%;
    }
    .comment-bubble::after{
      content:"";
      position:absolute;
      bottom:-12px;
      left:50%;
      transform:translateX(-50%) rotate(45deg);
      width:22px;
      height:22px;
      background:var(--card);
      box-shadow:0 4px 12px rgba(0,0,0,.4);
      border-right:1px solid rgba(255,255,255,.06);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .comment-quote{
      font-size:32px;
      line-height:1;
      opacity:.6;
      margin-bottom:8px;
    }
        .comment-text{
      font-size:14px;
      color:var(--text);
      line-height:1.7;
    }

    .comment-delete-form{
      margin-left:auto;  
    }

    .comment-delete-btn{
      border-radius:999px;
      border:1px solid rgba(255,255,255,.24);
      background:transparent;
      color:var(--muted);
      font-size:11px;
      padding:4px 10px;
      cursor:pointer;
      letter-spacing:.05em;
      text-transform:uppercase;
      white-space:nowrap;
    }

    .comment-delete-btn:hover{
      background:rgba(255,255,255,.16);
      color:#000;
    }


    .comment-meta{
      display:flex;
      align-items:center;
      gap:12px;
      padding-left:4px;
      margin-top:6px;
    }
    .comment-avatar{
      position:relative;
      width:48px;
      height:48px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #fff, #999);
      overflow:hidden;
      flex-shrink:0;
      box-shadow:0 0 0 2px rgba(0,0,0,.4);
    }
    .comment-avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      border-radius:50%;
      display:block;
      position:relative;
      z-index:1;
    }
    .comment-avatar::before{
      content:"";
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 20% 20%, rgba(255,255,255,.35), transparent 55%);
      mix-blend-mode:screen;
      opacity:.9;
    }
    .comment-avatar span{
      position:relative;
      display:flex;
      width:100%;
      height:100%;
      align-items:center;
      justify-content:center;
      font-size:12px;
      font-weight:600;
      color:#111;
    }
    .comment-author{
      font-size:14px;
    }
    .comment-author-name{
      font-weight:600;
    }
    .comment-author-sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }

    @media (max-width:768px){
      .comments-header{
        flex-direction:column;
        align-items:flex-start;
      }
      .comment-form-footer{
        flex-direction:column;
        align-items:flex-start;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="site navbar">
      <div class="brand">
        <a href="/" style="text-decoration:none;color:inherit">
          <img src="{{ url_for('static', filename='cover/logo.png') }}" alt="MY SHELF" />
        </a>
      </div>
      <div class="nav-actions">
        <div class="search" role="search">
          <input type="search" placeholder="Search" aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" />
          <button aria-label="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">‚åï</button>
        </div>
        <button class="icon-btn" aria-label="‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô">‚úèÔ∏è</button>
        <button class="icon-btn" aria-label="‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô">üîî</button>
        <button class="icon-btn" aria-label="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å">‚ù§</button>
        <button class="icon-btn" aria-label="‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå">üë§</button>
      </div>
    </div>
  </header>

  <main class="site">
    <a href="/" class="back-link">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>

    <!-- Novel Header (React-like UI) -->
<section class="novel-header">
  <!-- ‡∏ã‡πâ‡∏≤‡∏¢: ‡∏õ‡∏Å + ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
  <div class="novel-left">
    <div class="cover-card">
      <img
        class="cover-image"
        src="{{ novel.cover_url or url_for('static', filename='cover/placeholder.jpg') }}"
        alt="{{ novel.title }}"
      />
    </div>

    <!-- ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô + ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
<form
  id="ratingForm"
  class="rating-card"
  method="post"
  action="{{ url_for('novel.rate', novels_id=novel.novels_id) }}"
>
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ö‡∏ô: ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ã‡πâ‡∏≤‡∏¢ + ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏ß‡∏≤ -->
  <div class="rating-card-top">
    <div class="rating-card-header">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>

    <div class="rating-card-score">
      {% if novel.rating_count > 0 %}
        <span class="rating-score-main">
          {{ "%.1f"|format(novel.avg_rating) }}
        </span>
        <span class="rating-score-max">/5</span>
      {% else %}
        <span class="rating-score-main">‚Äî</span>
        <span class="rating-score-max">/5</span>
      {% endif %}
    </div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏≠‡∏á: ‡∏î‡∏≤‡∏ß‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô -->
  <div class="rating-card-stars">
    <div class="star-rating">
      {% set ur = novel.user_rating or 0 %}
      {% for star in range(5, 0, -1) %}
        <input
          type="radio"
          id="rating-{{ star }}"
          name="rating"
          value="{{ star }}"
          {% if ur == star %}checked{% endif %}
        >
        <label for="rating-{{ star }}" title="{{ star }} ‡∏î‡∏≤‡∏ß">‚òÖ</label>
      {% endfor %}
    </div>
  </div>

  <!-- ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏á: ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô + hint -->
  <div class="rating-card-footer">
    {% if novel.rating_count > 0 %}
      <span class="rating-count">
        ‡∏à‡∏≤‡∏Å {{ novel.rating_count }} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
      </span>
    {% else %}
      <span class="rating-count">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
      </span>
    {% endif %}
    <span class="rating-hint">‡πÅ‡∏ï‡∏∞‡∏î‡∏≤‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</span>
  </div>
</form>
  </div>


  <!-- ‡∏Ç‡∏ß‡∏≤: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢ -->
  <div class="novel-main">
    <h1 class="novel-title">{{ novel.title }}</h1>

    {% if novel.author_name is defined and novel.author_name %}
      <div class="novel-author-line">
        ‡πÇ‡∏î‡∏¢ <span class="novel-author">{{ novel.author_name }}</span>
      </div>
    {% endif %}

    {% if novel.updated_at is defined and novel.updated_at %}
      <div class="novel-submeta">
        ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {{ novel.updated_at.strftime('%d/%m/%Y') }}
      </div>
    {% endif %}

    <!-- ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
      <div class="tag-list">
        {% if novel.category_name %}
          <span class="tag-pill">{{ novel.category_name }}</span>
        {% endif %}

        {% if novel.status %}
          <span class="tag-pill">
            {% if novel.status == "completed" %}
              ‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß
            {% elif novel.status == "ongoing" %}
              ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö
            {% else %}
              {{ novel.status }}
            {% endif %}
          </span>
        {% endif %}
      </div>

      <!-- ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ -->
     <div class="novel-stats">
        <!-- ‡∏ú‡∏π‡πâ‡∏≠‡πà‡∏≤‡∏ô -->
        <div class="stat-item">
          <span class="stat-icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor">
              <path fill-rule="evenodd"
                d="M7.5 6a4.5 4.5 0 1 1 9 0 4.5 4.5 0 0 1-9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.683 18.683 0 0 1 12 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 0 1-.437-.695Z"
                clip-rule="evenodd" />
            </svg>
          </span>
          <span>
            {{ novel.total_readers or 0 }}
            ‡∏ú‡∏π‡πâ‡∏≠‡πà‡∏≤‡∏ô
          </span>
        </div>

        <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ï‡∏≠‡∏ô -->
        <div class="stat-item">
          <span class="stat-icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor">
              <path
                d="M5.625 3.75a2.625 2.625 0 1 0 0 5.25h12.75a2.625 2.625 0 0 0 0-5.25H5.625ZM3.75 11.25a.75.75 0 0 0 0 1.5h16.5a.75.75 0 0 0 0-1.5H3.75ZM3 15.75a.75.75 0 0 1 .75-.75h16.5a.75.75 0 0 1 0 1.5H3.75a.75.75 0 0 1-.75-.75ZM3.75 18.75a.75.75 0 0 0 0 1.5h16.5a.75.75 0 0 0 0-1.5H3.75Z" />
            </svg>
          </span>
          <span>{{ novel.total_chapters or 0 }} ‡∏ï‡∏≠‡∏ô</span>
        </div>

        <!-- ‡∏Å‡∏î‡∏ñ‡∏π‡∏Å‡πÉ‡∏à / ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ -->
        <div class="stat-item">
          <span class="stat-icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor">
              <path
                d="M11.25 4.533A9.707 9.707 0 0 0 6 3a9.735 9.735 0 0 0-3.25.555.75.75 0 0 0-.5.707v14.25a.75.75 0 0 0 1 .707A8.237 8.237 0 0 1 6 18.75c1.995 0 3.823.707 5.25 1.886V4.533ZM12.75 20.636A8.214 8.214 0 0 1 18 18.75c.966 0 1.89.166 2.75.47a.75.75 0 0 0 1-.708V4.262a.75.75 0 0 0-.5-.707A9.735 9.735 0 0 0 18 3a9.707 9.707 0 0 0-5.25 1.533v16.103Z" />
            </svg>
          </span>
          <span>{{ novel.total_favorites or 0 }}</span>
        </div>
      </div>


      <!-- ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠ -->
      {% if novel.description %}
        <div class="novel-description-block">
          <h2 class="section-heading">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠</h2>
          <p class="novel-description">
            {{ novel.description }}
          </p>
        </div>
      {% endif %}

      <!-- ‡∏õ‡∏∏‡πà‡∏° action -->
<div class="novel-actions">
  <a
    href="/reading/read/{{ novel.novels_id }}/1"
    class="btn-lg"
  >
    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πà‡∏≤‡∏ô
  </a>


      <!-- ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ / ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß -->
        <form id="bookshelf-form"
              method="post"
              action="{{ url_for('novel.toggle_bookshelf', novels_id=novel.novels_id) }}"
              style="display:none;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="next_sort" value="{{ request.args.get('sort', 'asc') }}">
        </form>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î -->
        <button type="button"
                id="bookshelfToggleBtn"
                class="btn-lg btn-lg-ghost bookshelf-btn{% if novel.in_bookshelf %} bookshelf-btn--active{% endif %}">
          <span class="btn-icon" aria-hidden="true">
            <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° -->
            <svg xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="currentColor"
                class="size-6">
              <path d="M11.25 4.533A9.707 9.707 0 0 0 6 3a9.735 9.735 0 0 0-3.25.555.75.75 0 0 0-.5.707v14.25a.75.75 0 0 0 1 .707A8.237 8.237 0 0 1 6 18.75c1.995 0 3.823.707 5.25 1.886V4.533ZM12.75 20.636A8.214 8.214 0 0 1 18 18.75c.966 0 1.89.166 2.75.47a.75.75 0 0 0 1-.708V4.262a.75.75 0 0 0-.5-.707A9.735 9.735 0 0 0 18 3a9.707 9.707 0 0 0-5.25 1.533v16.103Z" />
            </svg>
          </span>

          <span>
            {% if novel.in_bookshelf %}
              ‡∏≠‡∏¢‡∏π‡πà‡∏ö‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÅ‡∏•‡πâ‡∏ß
            {% else %}
              ‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠
            {% endif %}
          </span>
        </button>




  <!-- ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå + icon ‡πÅ‡∏ä‡∏£‡πå -->
    <button type="button"
            class="btn-lg btn-lg-ghost"
            id="copyLinkBtn"
            data-copy-url="{{ request.url }}">  <!-- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ Jinja ‡∏à‡∏∞‡∏•‡∏ö attribute ‡∏ô‡∏µ‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ -->
      <span class="btn-icon" aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24" fill="currentColor" class="size-6">
          <path fill-rule="evenodd" d="M7.502 6h7.128A3.375 3.375 0 0 1 18 9.375v9.375a3 3 0 0 0 3-3V6.108c0-1.505-1.125-2.811-2.664-2.94a48.972 48.972 0 0 0-.673-.05A3 3 0 0 0 15 1.5h-1.5a3 3 0 0 0-2.663 1.618c-.225.015-.45.032-.673.05C8.662 3.295 7.554 4.542 7.502 6ZM13.5 3A1.5 1.5 0 0 0 12 4.5h4.5A1.5 1.5 0 0 0 15 3h-1.5Z" clip-rule="evenodd" />
          <path fill-rule="evenodd" d="M3 9.375C3 8.339 3.84 7.5 4.875 7.5h9.75c1.036 0 1.875.84 1.875 1.875v11.25c0 1.035-.84 1.875-1.875 1.875h-9.75A1.875 1.875 0 0 1 3 20.625V9.375Zm9.586 4.594a.75.75 0 0 0-1.172-.938l-2.476 3.096-.908-.907a.75.75 0 0 0-1.06 1.06l1.5 1.5a.75.75 0 0 0 1.116-.062l3-3.75Z" clip-rule="evenodd" />
        </svg>
      </span>
      <span class="copy-label">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå</span>
    </button>

  </div>
    </div>
  </section>



           <!-- Chapters List -->
        <section class="chapters-section">
      <div class="chapters-header">
        <h2 class="chapters-heading">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ô</h2>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á ‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà / ‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤ -->
        <button type="button" id="chaptersSortToggle" class="chapters-sort-toggle">
          <span id="chaptersSortLabel" class="chapters-sort-label">‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà</span>
          <span class="chapters-sort-icon">‚ñæ</span>
        </button>
      </div>

      {% if chapters %}
      <div class="chapters-accordion" id="chaptersAccordion">
        {% set total_chapters = chapters|length %}
        {% set groups = namespace(current=-1) %}

        {% for chapter in chapters %}
          {# index ‡∏Ç‡∏≠‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏ö 0) #}
          {% set g_index = (loop.index0 // 50) %}

          {# ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà #}
          {% if g_index != groups.current %}
            {# ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏≠‡∏±‡∏ô‡πÅ‡∏£‡∏Å) #}
            {% if not loop.first %}
                  </div>  {# .chapters-list #}
                </div>    {# .chapter-group-body #}
              </div>      {# .chapter-group #}
            {% endif %}

            {% set groups.current = g_index %}
            {% set group_start_index = g_index * 50 %}
            {% set group_start = group_start_index + 1 %}
            {% set remaining = total_chapters - group_start_index %}

            {% if remaining > 50 %}
              {% set group_count = 50 %}
            {% else %}
              {% set group_count = remaining %}
            {% endif %}
            {% set group_end = group_start + group_count - 1 %}

            {# ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡∏ï‡∏≠‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1‚Äì50, 51‚Äì100 ... #}
            <div class="chapter-group{% if g_index == 0 %} is-open{% endif %}"
                data-group-index="{{ g_index }}">
              <button class="chapter-group-header" type="button">
                <div class="chapter-group-title">
                  ‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà {{ group_start }}‚Äì{{ group_end }}
                </div>
                <div class="chapter-group-meta">
                  <span class="chapter-group-count">{{ group_count }} ‡∏ï‡∏≠‡∏ô</span>
                  <span class="chapter-group-caret">‚ñæ</span>
                </div>
              </button>

              <div class="chapter-group-body">
                <div class="chapters-list">
          {% endif %}

                  {# ‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≠‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏≠‡∏ô #}
                  <div class="chapter-row" data-chapter-no="{{ chapter.chapter_no|int }}">
                    <div class="chapter-row-inner">
                      <!-- ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡∏≠‡∏ô -->
                      <a class="chapter-main"
                        href="/reading/read/{{ novel.novels_id }}/{{ chapter.chapter_no }}">
                        <span class="chapter-label">
                          ‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà {{ chapter.chapter_no }}
                        </span>
                        <span class="chapter-title">
                          {{ chapter.title or '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≠‡∏ô' }}
                        </span>
                      </a>

                      <div class="chapter-meta">
                        <span class="chapter-date">
                          {{ chapter.created_at.strftime('%d/%m/%Y') if chapter.created_at else '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏' }}
                        </span>

                  
                        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏´‡∏±‡∏ß‡πÉ‡∏à -->
                  <div class="chapter-like-wrap">
                        <form class="chapter-like-form"
                              method="post"
                              action="{{ url_for('novel.toggle_chapter_like',
                                                novels_id=novel.novels_id,
                                                chapters_id=chapter.chapters_id) }}">
                          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                          <button type="submit"
                                class="chapter-like-btn{% if chapter.is_liked %} liked{% endif %}">
                          <span class="heart-icon" aria-hidden="true">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 24 24"
                                fill="currentColor">
                              <path d="m11.645 20.91-.007-.003-.022-.012a15.247 15.247 0 0 1-.383-.218 25.18 25.18 0 0 1-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0 1 12 5.052 5.5 5.5 0 0 1 16.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 0 1-4.244 3.17 15.247 15.247 0 0 1-.383.219l-.022.012-.007.004-.003.001a.752.752 0 0 1-.704 0l-.003-.001Z" />
                            </svg>
                          </span>
                          <span class="like-count">{{ chapter.like_count or 0 }}</span>
                        </button>
                        </form>
                      </div>
                    </div>
                  </div>

          {% if loop.last %}
                </div>  {# .chapters-list #}
              </div>    {# .chapter-group-body #}
            </div>      {# .chapter-group #}
          {% endif %}
        {% endfor %}
      </div>            {# .chapters-accordion #}

      {% else %}
        <p style="opacity:.7">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≠‡∏ô‡πÉ‡∏ô‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡∏ô‡∏µ‡πâ</p>
      {% endif %}
    </section>




    <!-- Comments (form + list) -->
    <section class="comments-wrap">
      <form class="comment-form" method="post"
            action="{{ url_for('novel.detail', novels_id=novel.novels_id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <textarea
          id="commentContent"
          name="content"
          maxlength="500"
          placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."
          required></textarea>
        <div class="comment-form-footer">
          <span class="char-count" id="commentCharCount">0/500</span>
          <button type="submit" class="comment-submit-btn">
            ‡∏™‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô
          </button>
        </div>
      </form>

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô -->
      <div class="summary-helper-wrap">
        <button type="button" class="summary-helper-btn" id="openSummaryHelper">
          ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô
        </button>
      </div>

      <!-- Modal ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) -->
      <div id="summaryModal" class="summary-modal" aria-hidden="true">
        <div class="summary-modal-overlay" data-summary-close></div>
        <div class="summary-modal-dialog" role="dialog"
            aria-modal="true" aria-labelledby="summaryModalTitle">
          <div class="summary-modal-header">
            <h3 id="summaryModalTitle" class="summary-modal-title">
              ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô
            </h3>
            <button type="button" class="summary-modal-close"
                    aria-label="‡∏õ‡∏¥‡∏î" data-summary-close>√ó</button>
          </div>
          <div class="summary-modal-body"></div>
        </div>
      </div>

      <div class="comments-header">
        <div class="comments-header-main">
          <h2>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏≠‡πà‡∏≤‡∏ô</h2>
        </div>
        <div class="comments-controls">
          <button type="button" class="comments-btn" id="commentsPrev"
                  aria-label="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤">‚ùÆ</button>
          <button type="button" class="comments-btn" id="commentsNext"
                  aria-label="‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">‚ùØ</button>
        </div>
      </div>

      <!-- ‡πÉ‡∏´‡πâ‡∏°‡∏µ track ‡πÄ‡∏™‡∏°‡∏≠ -->
      <div class="comments-track" id="commentsTrack">
        {% for c in comments %}
        <article class="comment-card" data-cm-id="{{ c.cm_id }}">
          <div class="comment-bubble">
            <div class="comment-quote">‚Äú</div>
            <p class="comment-text">
              {{ c.content }}
            </p>
          </div>

          <div class="comment-meta">
            <div class="comment-avatar">
              {% if c.avatar_url %}
                <img src="{{ c.avatar_url }}"
                    alt="{{ c.username or ('‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ #' ~ c.users_id) }}">
              {% else %}
                <span>{{ c.username or ('‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ #' ~ c.users_id) }}</span>
              {% endif %}
            </div>

            <div class="comment-author">
              <div class="comment-author-name">
                {{ c.username or ('‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ #' ~ c.users_id) }}
              </div>
              <div class="comment-author-sub">
                {% if c.created_at %}
                  {{ c.created_at.strftime('%d/%m/%Y') }}
                {% else %}
                  ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
                {% endif %}
              </div>
            </div>

            {% if c.can_delete %}
            <form class="comment-delete-form"
                  method="post"
                  action="{{ url_for('novel.delete_comment',
                                    novels_id=novel.novels_id,
                                    cm_id=c.cm_id) }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="comment-delete-btn">
                ‡∏•‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô
              </button>
            </form>
            {% endif %}
          </div>
        </article>
        {% endfor %}
      </div>

      {% if not comments %}
        <p id="noCommentsMessage" style="opacity:.7;margin-top:12px;">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡πÉ‡∏ô‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢‡∏ô‡∏µ‡πâ
        </p>
      {% endif %}
    </section>


  </main>

  <script>
   
    // script ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö carousel + effect ‡πÄ‡∏î‡∏¥‡∏°
    (function(){
      const track = document.getElementById('commentsTrack');
      const prevBtn = document.getElementById('commentsPrev');
      const nextBtn = document.getElementById('commentsNext');
      const cards = document.querySelectorAll('.comment-card');
      if (!track) return;

      const io = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{
          if(e.isIntersecting){
            e.target.classList.add('show');
            io.unobserve(e.target);
          }
        });
      }, {threshold:0.15});
      cards.forEach(c=>io.observe(c));

      const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
      document.querySelectorAll('.comment-bubble').forEach(bubble=>{
        bubble.addEventListener('mousemove', e=>{
          const r = bubble.getBoundingClientRect();
          const rx = ((e.clientY - r.top) / r.height - .5) * -6;
          const ry = ((e.clientX - r.left) / r.width - .5) *  6;
          bubble.style.transform = `rotateX(${clamp(rx,-6,6)}deg) rotateY(${clamp(ry,-6,6)}deg) translateZ(0)`;
        });
        bubble.addEventListener('mouseleave', ()=>{
          bubble.style.transform = '';
        });
      });

      const step = ()=> track.clientWidth * 0.7;
      if (prevBtn && nextBtn){
        prevBtn.addEventListener('click', ()=> {
          track.scrollBy({left:-step(), behavior:'smooth'});
        });
        nextBtn.addEventListener('click', ()=> {
          track.scrollBy({left: step(), behavior:'smooth'});
        });
      }

      let timer = null;
      const startAuto = ()=>{
        if (timer) return;
        timer = setInterval(()=> {
          if (nextBtn) nextBtn.click();
        }, 5000);
      };
      const stopAuto = ()=>{
        if (!timer) return;
        clearInterval(timer);
        timer = null;
      };
      startAuto();
      track.addEventListener('mouseenter', stopAuto);
      track.addEventListener('mouseleave', startAuto);
    })();

    // script ‡∏ô‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÉ‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 500)
    (function(){
      const textarea = document.getElementById('commentContent');
      const counter  = document.getElementById('commentCharCount');
      if (!textarea || !counter) return;
      const max = parseInt(textarea.getAttribute('maxlength') || '500', 10);
      const update = () => {
        const len = textarea.value.length;
        counter.textContent = `${len}/${max}`;
      };
      textarea.addEventListener('input', update);
      update();
    })();

    

        // Accordion + sort chapters (‡πÅ‡∏ö‡∏ö 1‚Äì50, 51‚Äì100 ...)
        (function () {
          const accordion  = document.getElementById('chaptersAccordion');
          const sortBtn    = document.getElementById('chaptersSortToggle');
          const sortLabel  = document.getElementById('chaptersSortLabel');

          if (!accordion) return;

          // toggle ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î group
          accordion.addEventListener('click', function (e) {
            const header = e.target.closest('.chapter-group-header');
            if (!header || !accordion.contains(header)) return;

            const group = header.closest('.chapter-group');
            if (!group) return;

            const isOpen = group.classList.contains('is-open');

            // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡∏ó‡∏µ‡∏•‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            accordion.querySelectorAll('.chapter-group.is-open').forEach(g => {
              if (g !== group) g.classList.remove('is-open');
            });

            if (isOpen) {
              group.classList.remove('is-open');   // ‡∏û‡∏±‡∏ö‡∏Å‡∏•‡πà‡∏≠‡∏á
            } else {
              group.classList.add('is-open');      // ‡∏Å‡∏≤‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á
            }
          });

          // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Å‡∏•‡πà‡∏≠‡∏á
          function sortChapters(direction) {
            const lists = accordion.querySelectorAll('.chapters-list');
            lists.forEach(list => {
              const rows = Array.from(list.querySelectorAll('.chapter-row'));
              rows.sort((a, b) => {
                const na = parseFloat(a.dataset.chapterNo || '0');
                const nb = parseFloat(b.dataset.chapterNo || '0');
                return direction === 'asc' ? na - nb : nb - na;
              });
              rows.forEach(row => list.appendChild(row));
            });
          }


      // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô: ‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà
      let direction = 'asc';
      sortChapters(direction);

      if (!sortBtn) return;

      sortBtn.addEventListener('click', function () {
        direction = direction === 'asc' ? 'desc' : 'asc';

        if (sortLabel) {
          sortLabel.textContent = direction === 'asc'
            ? '‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà'
            : '‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏õ‡πÄ‡∏Å‡πà‡∏≤';
        }
        sortBtn.classList.toggle('desc', direction === 'desc');

        sortChapters(direction);
      });
    })();


    // auto submit rating form ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏î‡∏≤‡∏ß
    (function(){
      const form = document.querySelector('.rating-form');
      if (!form) return;
      const inputs = form.querySelectorAll('.rating-input');
      inputs.forEach(input=>{
        input.addEventListener('change', ()=>{
          form.submit();
        });
      });
    })();

    document.addEventListener('DOMContentLoaded', function () {
  const btn = document.getElementById('copyLinkBtn');
  if (!btn) return;

  const labelSpan = btn.querySelector('.copy-label');
  const originalText = labelSpan.textContent;

  btn.addEventListener('click', function () {
    const urlToCopy = btn.dataset.copyUrl || window.location.href;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á clipboard ‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞ fallback ‡πÄ‡∏î‡∏¥‡∏°)
      function doCopy(text) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          return navigator.clipboard.writeText(text);
        }
        return new Promise(function (resolve, reject) {
          const tempInput = document.createElement('textarea');
          tempInput.value = text;
          tempInput.style.position = 'fixed';
          tempInput.style.left = '-9999px';
          document.body.appendChild(tempInput);
          tempInput.select();
          try {
            document.execCommand('copy');
            resolve();
          } catch (err) {
            reject(err);
          } finally {
            document.body.removeChild(tempInput);
          }
        });
      }

      doCopy(urlToCopy).then(function () {
        // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏ô‡∏õ‡∏∏‡πà‡∏° 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
        labelSpan.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
        btn.classList.add('copied');
        btn.disabled = true;

        setTimeout(function () {
          labelSpan.textContent = originalText;
          btn.classList.remove('copied');
          btn.disabled = false;
        }, 2000);
      }).catch(function (err) {
        console.error('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', err);
        // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡πá‡∏ó‡∏≥‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ
      });
    });
  })();

    // --- ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô: modal + fetch summary ‡∏à‡∏≤‡∏Å backend ---
    (function(){
      const openBtn = document.getElementById('openSummaryHelper');
      const modal   = document.getElementById('summaryModal');
      if (!openBtn || !modal) return;

      const overlay    = modal.querySelector('.summary-modal-overlay');
      const closeEls   = modal.querySelectorAll('[data-summary-close]');
      const body       = document.body;
      const contentEl  = modal.querySelector('.summary-modal-body');

      // URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô ‡∏à‡∏≤‡∏Å blueprint novel.comment_summary
      const summaryUrl = "{{ url_for('novel.comment_summary', novels_id=novel.novels_id) }}";

      // ‡∏î‡∏∂‡∏á CSRF token ‡∏à‡∏≤‡∏Å input hidden ‡∏ï‡∏±‡∏ß‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ
      function getCsrfToken() {
        const input = document.querySelector('input[name="csrf_token"]');
        return input ? input.value : null;
      }

      function showLoading() {
        if (!contentEl) return;
        contentEl.innerHTML = `
          <p>
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏≠‡πà‡∏≤‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà... ‚ú®<br>
            (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà ‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô)
          </p>
        `;
      }

      function showError(msg) {
        if (!contentEl) return;
        const text = msg || "‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á";
        contentEl.innerHTML = `
          <p style="color:#ff9f9f;">
            ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏≠‡πà‡∏≤‡∏ô<br>
            ${text}
          </p>
        `;
      }

            function showSummary(summary, fromCache) {
        if (!contentEl) return;

        const raw = (summary || "").trim();
        const safeSummary = raw
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° fallback ‡∏ß‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á note ‡πÉ‡∏î ‡πÜ
        const isFallback = raw.startsWith("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡∏î‡πâ‡∏ß‡∏¢ AI ‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ");

        let noteHtml = "";
        if (!isFallback) {
          if (fromCache) {
            noteHtml =
              '<p style="font-size:12px;opacity:.75;margin-top:8px;">' +
              '(‡πÉ‡∏ä‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)' +
              "</p>";
          } else {
            noteHtml =
              '<p style="font-size:12px;opacity:.75;margin-top:8px;">' +
              '(‡∏û‡∏∂‡πà‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)' +
              "</p>";
          }
        }

        contentEl.innerHTML =
          "<p>" + safeSummary.replace(/\n/g, "<br>") + "</p>" + noteHtml;
      }

      async function fetchSummary() {
        showLoading();

        try {
          const headers = {
            "Content-Type": "application/json"
          };
          const csrf = getCsrfToken();
          if (csrf) {
            // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠ header ‡∏Ç‡∏≠‡∏á Flask-WTF
            headers["X-CSRFToken"]   = csrf;
            headers["X-CSRF-Token"] = csrf;
          }

          const resp = await fetch(summaryUrl, {
            method: "POST",
            headers,
            body: JSON.stringify({})  // backend ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô body ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
          });

          let data = {};
          try {
            data = await resp.json();
          } catch (e) {
            data = {};
          }

          if (!resp.ok || !data.ok) {
            const msg = (data && (data.error || data.message)) || "";
            showError(msg);
            return;
          }

          showSummary(data.summary || "", !!data.from_cache);
        } catch (err) {
          console.error("fetch summary error", err);
          showError("");
        }
      }

      const openModal = () => {
        modal.classList.add('active');
        body.style.overflow = 'hidden'; // ‡∏Å‡∏±‡∏ô scroll ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
        fetchSummary();                  // ‡∏Å‡∏î‡∏õ‡∏∏‡πä‡∏ö ‡∏¢‡∏¥‡∏á‡∏´‡∏≤ summary ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      };

      const closeModal = () => {
        modal.classList.remove('active');
        body.style.overflow = '';
      };

      openBtn.addEventListener('click', openModal);
      closeEls.forEach(el => el.addEventListener('click', closeModal));
      if (overlay) overlay.addEventListener('click', closeModal);

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          closeModal();
        }
      });
    })();

    

  </script>
</body>
</html>
