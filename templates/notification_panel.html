{% set _container_id = container_id|default('notiContainer') %}

<div id="{{ _container_id }}"
     class="relative bg-white rounded-2xl shadow-sm max-w-2xl ring-1 ring-slate-200 overflow-hidden"
     aria-live="polite">

  <!-- CSRF ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏¢‡∏¥‡∏á AJAX -->
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

  <!-- Header -->
  <div class="flex items-center justify-between px-4 py-3 border-b">
    <div class="flex items-center gap-2">
      <svg class="w-5 h-5 text-slate-700" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round"
              d="M15 17h5l-1.4-1.4A4 4 0 0 1 18 12V9a6 6 0 1 0-12 0v3c0 1.1-.4 2.1-1.1 2.9L3 17h5m6 0v1a3 3 0 1 1-6 0v-1" />
      </svg>
      <span class="font-semibold">Notifications</span>
      <span data-role="unread-count"
            class="ml-1 text-xs font-semibold px-2 py-0.5 rounded-full bg-slate-100 text-slate-700">
        {{ unread_count or 0 }}
      </span>
    </div>

    <div class="flex items-center gap-2">
      <!-- ‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
      <button data-action="mark-all"
              data-url="{{ url_for('noti.mark_all_read') }}"
              class="p-1.5 rounded-lg hover:bg-slate-100"
              title="‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
        <svg class="w-5 h-5 text-slate-600" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
        </svg>
      </button>
    </div>
  </div>

  <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
  <ul class="divide-y divide-slate-100 max-h-[70vh] overflow-y-auto">
    {% if notifications %}
      {% for n in notifications %}
        <li data-unread="{{ 0 if n.is_read else 1 }}"
            class="{{ '' if n.is_read else 'bg-slate-50' }}">
          <div class="flex items-start gap-3 p-4">
            <!-- ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏ß‡∏á‡∏Å‡∏•‡∏° -->
            <div data-role="noti-icon"
                 class="shrink-0 inline-flex h-10 w-10 items-center justify-center rounded-full
                        {{ 'bg-slate-200 text-slate-700' if not n.is_read else 'bg-slate-100 text-slate-500' }}">
              {% if n.type == 'new_chapter' %}
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M6 4a2 2 0 0 0-2 2v12.5A2.5 2.5 0 0 0 6.5 21H19V6a2 2 0 0 0-2-2H6zM6.5 19a.5.5 0 0 1-.5-.5V6h11v13h-10.5z"/>
                </svg>
              {% elif n.type == 'chapter_updated' %}
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zm14.85-9.1a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                </svg>
              {% elif n.type == 'comment' %}
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M20 2H4a2 2 0 0 0-2 2v14l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/>
                </svg>
              {% elif n.type == 'favorite' %}
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 17.3 6.18 21l1.64-7.03L3 9.24l7.19-.62L12 2l1.81 6.62L21 9.24l-4.82 4.73L17.82 21z"/>
                </svg>
              {% elif n.type == 'bookshelf_add' %}
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M7 4h10v2H7V4zm0 4h10v2H7V8zm0 4h6v2H7v-2zm-2 6h14v2H5v-2zm0-2h2V4H5v16z"/>
                </svg>
              {% elif n.type == 'rating' %}
                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 17.3 8.24 19.5 9.24 15.1 6 12.24l4.38-.38L12 7.9l1.62 3.96 4.38.38-3.24 2.86 1 4.4z"/>
                </svg>
              {% else %}
                <span class="text-lg">üîî</span>
              {% endif %}
            </div>

            <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ -->
            <div class="flex-1 min-w-0">
              <div class="flex items-start justify-between gap-2">
                <div class="font-semibold text-slate-900">
                  {{ n.type_label }}
                  {% if n.novel_title %}
                    ‚Äî <span class="font-normal text-slate-700">
                      {{ n.novel_title }}{% if n.chapter_no %} ‚Ä¢ ‡∏ï‡∏≠‡∏ô {{ n.chapter_no }}{% endif %}
                    </span>
                  {% endif %}
                </div>
                <div class="text-xs text-slate-400 whitespace-nowrap">
                  {{ n.created_at_display }}
                </div>
              </div>

              <p class="mt-0.5 text-sm text-slate-600 line-clamp-2">{{ n.message }}</p>

              <div class="mt-3 flex items-center gap-2">
                {% if n.is_read %}
                  <button data-action="toggle-read"
                          data-url="{{ url_for('noti.mark_read', nid=n.notification_id) }}"
                          data-read="0"
                          class="btn-read px-3 py-1.5 rounded-lg border text-sm hover:bg-slate-50">
                    ‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô
                  </button>
                {% else %}
                  <button data-action="toggle-read"
                          data-url="{{ url_for('noti.mark_read', nid=n.notification_id) }}"
                          data-read="1"
                          class="btn-read px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm hover:bg-black">
                    ‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß
                  </button>
                {% endif %}

                <button data-action="delete"
                        data-url="{{ url_for('noti.delete_notification', nid=n.notification_id) }}"
                        class="btn-del px-3 py-1.5 rounded-lg border border-red-300 text-red-600 text-sm hover:bg-red-50">
                  ‡∏•‡∏ö
                </button>
              </div>
            </div>
          </div>
        </li>
      {% endfor %}
    {% else %}
      <li>
        <div class="p-8 text-center text-slate-500">
          ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        </div>
      </li>
    {% endif %}
  </ul>
</div>

<!-- ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ú‡∏π‡∏Å‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå & ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï DOM ‡πÅ‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤ -->
<script>
  (function(){
    const containerId = "{{ _container_id }}";
    const container = document.getElementById(containerId);
    if (!container) return;

    function getCsrfToken(){
      const input = container.querySelector('input[name="csrf_token"]');
      return input ? input.value : "";
    }

    async function apiPost(url, payload){
      const body = new URLSearchParams(payload || {});
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8"
        },
        body: body.toString()
      });
      if (!res.ok){
        throw new Error("HTTP " + res.status);
      }
      return await res.json();
    }

    function updateBadge(){
      const badge = container.querySelector("[data-role='unread-count']");
      if (!badge) return;
      const count = container.querySelectorAll("li[data-unread='1']").length;
      badge.textContent = count;
    }

    function applyReadState(li, isRead){
      if (!li) return;
      li.dataset.unread = isRead ? "0" : "1";
      li.className = isRead ? "" : "bg-slate-50";

      const icon = li.querySelector("[data-role='noti-icon']");
      if (icon){
        icon.className =
          "shrink-0 inline-flex h-10 w-10 items-center justify-center rounded-full " +
          (isRead ? "bg-slate-100 text-slate-500" : "bg-slate-200 text-slate-700");
      }

      const btn = li.querySelector("[data-action='toggle-read']");
      if (btn){
        if (isRead){
          btn.textContent = "‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô";
          btn.dataset.read = "0";
          btn.className =
            "btn-read px-3 py-1.5 rounded-lg border text-sm hover:bg-slate-50";
        } else {
          btn.textContent = "‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
          btn.dataset.read = "1";
          btn.className =
            "btn-read px-3 py-1.5 rounded-lg bg-slate-900 text-white text-sm hover:bg-black";
        }
      }
    }

    async function handleToggleRead(btn){
      const url = btn.dataset.url;
      const readVal = btn.dataset.read || "1";  // 1 = ‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß, 0 = ‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡πà‡∏≤‡∏ô
      const li = btn.closest("li");
      await apiPost(url, {
        read: readVal,
        csrf_token: getCsrfToken()
      });
      const isRead = (readVal === "1");
      applyReadState(li, isRead);
      updateBadge();
    }

    async function handleDelete(btn){
      if (!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡πÑ‡∏´‡∏°?")) return;
      const url = btn.dataset.url;
      const li = btn.closest("li");
      await apiPost(url, { csrf_token: getCsrfToken() });
      if (li) li.remove();
      updateBadge();

      const anyItem = container.querySelector("li[data-unread]");
      if (!anyItem){
        const ul = container.querySelector("ul");
        if (ul){
          const empty = document.createElement("li");
          empty.innerHTML =
            '<div class="p-8 text-center text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</div>';
          ul.appendChild(empty);
        }
      }
    }

    async function handleMarkAll(btn){
      const url = btn.dataset.url;
      await apiPost(url, { csrf_token: getCsrfToken() });
      container.querySelectorAll("li[data-unread]").forEach((li)=>{
        applyReadState(li, true);
      });
      updateBadge();
    }

    async function guardedAction(btn, fn){
      if (!btn) return;
      if (btn._loading) return;
      btn._loading = true;
      btn.disabled = true;
      btn.classList.add("opacity-60");
      try {
        await fn();
      } catch (e){
        console.error(e);
        alert("‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
      } finally {
        btn.disabled = false;
        btn.classList.remove("opacity-60");
        btn._loading = false;
      }
    }

    // Event delegation ‡πÉ‡∏ô panel ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    container.addEventListener("click", (ev)=>{
      const btn = ev.target.closest("[data-action]");
      if (!btn || !container.contains(btn)) return;
      const action = btn.dataset.action;
      if (action === "toggle-read"){
        guardedAction(btn, ()=>handleToggleRead(btn));
      } else if (action === "delete"){
        guardedAction(btn, ()=>handleDelete(btn));
      } else if (action === "mark-all"){
        guardedAction(btn, ()=>handleMarkAll(btn));
      }
    });

  })();
</script>
