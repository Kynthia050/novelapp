<header class="sticky top-0 z-50 bg-[rgba(31,31,33,.98)] bg-gradient-to-b from-[rgba(31,31,33,.98)] to-[rgba(31,31,33,.95)] backdrop-blur-sm border-b border-white/10">
  <div class="mx-auto max-w-[1200px] px-4 md:px-6">
    <nav class="flex items-center gap-4 py-3.5">
      <a href="/" class="shrink-0 inline-flex items-center gap-3">
        <img src="{{ url_for('static', filename='cover/logo.png') }}" alt="MY SHELF" class="h-[48px] md:h-[60px] w-auto object-contain" />
      </a>

      <div class="ml-auto flex items-center gap-2">

        {# ---- SEARCH BAR ---- #}
        <form
          role="search"
          data-header-search="1"
          class="relative min-w-[220px] sm:min-w-[280px]"
          action="{{ url_for('search.search_novels') }}"
          method="get"
        >
          <input
            type="text"
            name="q"
            placeholder="Search"
            value="{{ request.args.get('q', '') }}"
            aria-label="ค้นหา"
            autocomplete="off"
            class="w-full rounded-full bg-[#111214] border border-white/10 pl-10 pr-10 py-2 text-textc placeholder-white/50 outline-none focus:ring-2 focus:ring-white/20 focus:border-white/30 transition"
          />

          {# ปุ่มแว่นขยาย (ซ้าย) #}
          <button
            type="submit"
            class="absolute inset-y-0 left-0 pl-3 pr-2 grid place-items-center text-muted"
            aria-label="ค้นหา"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="1.5"
                d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 1 0 0-15 7.5 7.5 0 0 0 0 15z"
              />
            </svg>
          </button>

          {# ปุ่ม X เคลียร์ข้อความ (ขวา) ใช้ SVG ที่ให้มา #}
          <button
            type="button"
            data-action="clear-search"
            class="absolute inset-y-0 right-0 pr-3 pl-2 grid place-items-center text-muted hidden"
            aria-label="ล้างคำค้นหา"
          >
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
              <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-1.72 6.97a.75.75 0 1 0-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 13.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L13.06 12l1.72-1.72a.75.75 0 1 0-1.06-1.06L12 10.94l-1.72-1.72Z" clip-rule="evenodd" />
            </svg>
          </button>
        </form>

        {% set iconBtn = "w-9 h-9 rounded-full border border-white/10 bg-[#111214] text-muted grid place-items-center hover:border-white/20 hover:text-textc transition" %}

        {# --- งานเขียน: ใช้ SVG ปากกา/แก้ไข --- #}
        <a href="{{ url_for('mywrite') }}" class="{{ iconBtn }}" aria-label="งานเขียน">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
            <path d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32l8.4-8.4Z" />
            <path d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z" />
          </svg>
        </a>

        {# --- แจ้งเตือน: ใช้ SVG ใหม่ + จุดแดง --- #}
        <button
          type="button"
          id="btnNotifications"
          class="{{ iconBtn }} relative"
          aria-haspopup="dialog"
          aria-controls="notificationsModal"
          aria-label="แจ้งเตือน"
        >
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
            <path
              d="M5.85 3.5a.75.75 0 0 0-1.117-1 9.719 9.719 0 0 0-2.348 4.876.75.75 0 0 0 1.479.248A8.219 8.219 0 0 1 5.85 3.5ZM19.267 2.5a.75.75 0 1 0-1.118 1 8.22 8.22 0 0 1 1.987 4.124.75.75 0 0 0 1.48-.248A9.72 9.72 0 0 0 19.266 2.5Z"
            />
            <path
              fill-rule="evenodd"
              d="M12 2.25A6.75 6.75 0 0 0 5.25 9v.75a8.217 8.217 0 0 1-2.119 5.52.75.75 0 0 0 .298 1.206c1.544.57 3.16.99 4.831 1.243a3.75 3.75 0 1 0 7.48 0 24.583 24.583 0 0 0 4.83-1.244.75.75 0 0 0 .298-1.205 8.217 8.217 0 0 1-2.118-5.52V9A6.75 6.75 0 0 0 12 2.25ZM9.75 18c0-.034 0-.067.002-.1a25.05 25.05 0 0 0 4.496 0l.002.1a2.25 2.25 0 1 1-4.5 0Z"
              clip-rule="evenodd"
            />
          </svg>

          {# จุดแดงบอกว่ามีแจ้งเตือนใหม่ #}
          <span
            id="headerNotiDot"
            class="absolute -top-0.5 -right-0.5 inline-flex h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-[#111214]
                   {% if not (unread_count is defined and unread_count|int > 0) %}hidden{% endif %}"
          ></span>
        </button>

        {# --- ชั้นหนังสือ/หัวใจ: ใช้ SVG ใหม่ --- #}
        <a href="{{ url_for('bookshelf') }}" class="{{ iconBtn }}" aria-label="ชั้นหนังสือ">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
            <path
              d="M11.25 4.533A9.707 9.707 0 0 0 6 3a9.735 9.735 0 0 0-3.25.555.75.75 0 0 0-.5.707v14.25a.75.75 0 0 0 1 .707A8.237 8.237 0 0 1 6 18.75c1.995 0 3.823.707 5.25 1.886V4.533ZM12.75 20.636A8.214 8.214 0 0 1 18 18.75c.966 0 1.89.166 2.75.47a.75.75 0 0 0 1-.708V4.262a.75.75 0 0 0-.5-.707A9.735 9.735 0 0 0 18 3a9.707 9.707 0 0 0-5.25 1.533v16.103Z"
            />
          </svg>
        </a>

        {# --- โปรไฟล์: ใช้รูปจาก users.pfpic อย่างปลอดภัย --- #}
        {% if current_user is defined and current_user.is_authenticated and current_user.pfpic %}
          {% set profile_img = url_for('static', filename=current_user.pfpic) %}
        {% else %}
          {% set profile_img = url_for('static', filename='profile/default-avatar.png') %}
        {% endif %}

        <a href="{{ url_for('profile.profileusers') }}" class="{{ iconBtn }}" aria-label="โปรไฟล์">
          <img src="{{ profile_img }}" alt="โปรไฟล์ของฉัน" class="w-6 h-6 rounded-full object-cover" loading="lazy" />
        </a>
      </div>
    </nav>
  </div>
</header>

<!-- Notifications Modal -->
<div id="notificationsModal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true" aria-labelledby="notiTitle">
  <div id="notiBackdrop" class="absolute inset-0 bg-black/50"></div>
  <div class="absolute inset-0 flex items-start md:items-center justify-center p-4 md:p-6 overflow-y-auto">
    <div class="relative w-full max-w-md bg-white rounded-2xl shadow-2xl ring-1 ring-slate-200" id="notiContainer">
      <button type="button" class="absolute top-3 right-3 p-2 rounded-lg hover:bg-slate-100" aria-label="ปิด" id="notiClose">
        ✕
      </button>
      {% set container_id = 'notiContent' %}
      {% include 'notification_panel.html' %}
    </div>
  </div>
</div>

<!-- Notifications modal loader + search clear -->
<script>
  (function () {
    // --- Notifications modal ---
    const btn = document.getElementById("btnNotifications");
    const modal = document.getElementById("notificationsModal");
    const btnClose = document.getElementById("notiClose");
    const backdrop = document.getElementById("notiBackdrop");

    function openModal() {
      modal.classList.remove("hidden");
    }
    function closeModal() {
      modal.classList.add("hidden");
    }

    btn &&
      btn.addEventListener("click", async () => {
        openModal();

        // ดึง notiContent สด ๆ ทุกครั้ง
        let content = document.getElementById("notiContent");
        if (content) {
          content.innerHTML =
            '<div class="p-6 text-center text-slate-500">กำลังโหลด...</div>';
        }

        try {
          const res = await fetch(
            '{{ url_for("noti.notifications_page") }}?container_id=notiContent',
            {
              headers: { "X-Requested-With": "fetch" },
            }
          );
          const html = await res.text();

          // ดึง element อีกครั้งหลังจากอาจมีการเปลี่ยน DOM
          const current = document.getElementById("notiContent");
          if (current) current.outerHTML = html;
        } catch (e) {
          console.error(e);
          // fallback ถ้าไม่เจอ notiContent
          let fallback = document.getElementById("notiContent");
          if (!fallback) {
            fallback = document.createElement("div");
            fallback.id = "notiContent";
            const container = document.getElementById("notiContainer");
            if (container) container.appendChild(fallback);
          }
          fallback.innerHTML =
            '<div class="p-6 text-center text-red-600">โหลดไม่สำเร็จ</div>';
        }
      });

    btnClose && btnClose.addEventListener("click", closeModal);
    backdrop && backdrop.addEventListener("click", closeModal);
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });

    // --- Search clear button ---
    const searchForm = document.querySelector('form[role="search"][data-header-search]');
    if (searchForm) {
      const input = searchForm.querySelector('input[name="q"]');
      const clearBtn = searchForm.querySelector('[data-action="clear-search"]');

      if (input && clearBtn) {
        function toggleClear() {
          if (input.value.trim() !== "") {
            clearBtn.classList.remove("hidden");
          } else {
            clearBtn.classList.add("hidden");
          }
        }

        input.addEventListener("input", toggleClear);
        clearBtn.addEventListener("click", function () {
          input.value = "";
          toggleClear();
          input.focus();
        });

        // ตั้งค่าเริ่มต้นตามค่าที่มาจาก request.args
        toggleClear();
      }
    }
  })();
</script>
