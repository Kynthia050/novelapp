<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô ‚Äî MY SHELF</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            bg: '#222222',
            card: '#2b2c2f',
            chip: '#111214',
            line: 'rgba(255,255,255,.10)',
            accent: '#a3a3a3' // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡πÅ‡∏ó‡∏ô‡πÇ‡∏ó‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡πÄ‡∏î‡∏¥‡∏°
          },
          boxShadow: { soft: '0 10px 24px rgba(0,0,0,.45)' },
          borderRadius: { xl2: '16px' },
          fontFamily: {
            thai: ['Noto Sans Thai', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Arial', 'sans-serif'],
            brand: ['Georgia', 'Times New Roman', 'serif']
          },
          letterSpacing: { brand: '.25em', title: '.20em' }
        }
      }
    }
  </script>

  <style>
    .bg-hero { background-image: url('{{ url_for("static", filename="img/bg-login.jpg") }}'); background-size: cover; background-position: center; background-attachment: fixed; }
    .select-reset { appearance: none; -webkit-appearance: none; -moz-appearance: none; background-image: none; }

    /* ‡∏õ‡∏£‡∏±‡∏ö .menu-item ‡πÄ‡∏õ‡πá‡∏ô CSS ‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ @apply ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö CDN) */
    .menu-item{ display:flex; align-items:center; gap:.5rem; width:100%; text-align:left; padding:.5rem .75rem; border-radius:.5rem; }
    .menu-item:hover{ background: rgba(255,255,255,.05); }

    /* iframe modal */
    #remoteFrame { width: 100%; height: min(78vh, 900px); border: 0; border-radius: 12px; background: transparent; }
    /* loading state */
    .is-loading .loading-bar{ display:flex; }
    .loading-bar{ display:none; align-items:center; gap:.5rem; position:absolute; right:1rem; top:.75rem; padding:.25rem .5rem; border-radius:.5rem; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); font-size:.85rem; }
    .spinner{ width:18px; height:18px; border:3px solid rgba(255,255,255,.25); border-top-color: rgba(255,255,255,.85); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform: rotate(360deg); } }
  </style>
</head>
<body class="h-full font-thai text-white bg-bg">
  <!-- Background layer -->
  <div class="bg-hero fixed inset-0 -z-10"></div>
  <div class="fixed inset-0 -z-10 bg-black/50 backdrop-blur-sm"></div>

  <!-- Header -->
  <header class="sticky top-0 z-30 border-b border-white/10 bg-bg/80 backdrop-blur-md">
    {% include 'header.html' %}
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-6xl px-5 py-6">
    <!-- Page Bar -->
    <div class="flex items-center justify-between gap-3 mb-4">
      <h1 class="font-brand tracking-title text-[clamp(22px,3.2vw,34px)]">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</h1>
      <!-- ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ new_novel.html ‡πÅ‡∏ï‡πà‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏°‡∏î‡∏≠‡∏•‡∏î‡πâ‡∏ß‡∏¢ JS -->
      <a id="addBtn" href="/new_novel" class="inline-flex items-center gap-2 rounded-full bg-accent px-5 py-2.5 font-bold text-[#0b0b0b] shadow-soft hover:brightness-95 active:brightness-90 transition" role="button">
        <span class="text-lg">Ôºã</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô
      </a>
    </div>

    <!-- Controls -->
    <div class="flex flex-wrap items-center justify-between gap-3 my-3">
      <div class="flex items-center gap-3">
        <input id="checkAll" type="checkbox" class="h-5 w-5 rounded-md border border-white/20 bg-chip/70 text-accent focus:ring-2 focus:ring-accent/50" />
        <label for="checkAll" class="select-none">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>

        <div class="relative">
            <button id="manageBtn" class="rounded-xl border border-line bg-chip/80 px-4 py-2 hover:bg-chip/60 transition">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ ‚ñæ</button>
            <div id="manageMenu" class="absolute left-0 mt-2 hidden min-w-56 rounded-xl border border-line bg-card/95 p-2 shadow-soft z-20">
            <button data-action="publish" class="menu-item">‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
            <button data-action="complete" class="menu-item">‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</button>
            <button data-action="draft" class="menu-item">‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á</button>
            <div class="my-1 border-t border-white/10"></div>
            <button data-action="delete" class="menu-item" style="color:#fca5a5">‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="relative">
          <button id="filterBtn" class="rounded-xl border border-line bg-chip/80 px-4 py-2 hover:bg-chip/60 transition">
            <span id="filterLabel">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({{ total_works }})</span> ‚ñæ
          </button>
          <div id="filterMenu" class="absolute right-0 mt-2 hidden min-w-44 rounded-xl border border-line bg-card/95 p-2 shadow-soft z-20">
            <button data-filter="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" class="menu-item">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button data-filter="‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà" class="menu-item">‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</button>
            <button data-filter="‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß" class="menu-item">‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</button>
            <button data-filter="‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á" class="menu-item">‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á</button>
          </div>
        </div>
        <div class="flex items-center gap-2 text-white/70">
        </div>
      </div>
    </div>

    <!-- List -->
    <section id="list" class="grid gap-3">
      {% if works %}
        {% for w in works %}
          <article class="relative grid md:grid-cols-[auto,1fr,auto] grid-cols-1 gap-3 items-center rounded-xl border border-line bg-card/95 p-4 shadow-soft" data-id="{{ w.novels_id }}" data-status="{{ w.status or '‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á' }}" data-detail="{{ w.detail_url }}">
            <!-- left group -->
            <div class="flex items-center gap-3">
              <input type="checkbox" class="itemChk h-5 w-5 rounded-md border border-white/20 bg-chip/70 text-accent focus:ring-2 focus:ring-accent/50" value="{{ w.novels_id }}" />
              <img class="h-16 w-16 rounded-lg border border-white/10 object-cover" src="{{ w.cover_url }}" alt="{{ w.title }}" />
              <div class="min-w-0">
                <div class="text-[1.05rem] font-bold tracking-[.02em] truncate">
                  <a href="{{ url_for('editnovel.edit_novel', novels_id=w.novels_id) }}" class="no-underline text-white hover:text-accent transition">{{ w.title }}</a>
                </div>
                <div class="mt-0.5 flex flex-wrap items-center gap-3 text-white/70 text-[.92rem]">
                  <span>{{ w.category_name }}</span>
                  <span>‚Ä¢</span>
                  <span class="rounded-full border border-white/10 bg-[#35363a] px-2 py-0.5">{{ w.author_username }}</span>
                </div>
                <div class="mt-1 flex flex-wrap items-center gap-4 text-white/60 text-[.9rem]">
                  <span>üìö {{ w.chapters }}</span>
                  <span>üëÅÔ∏è {{ "{:,.0f}".format(w.views) }}</span>
                  <span>üí¨ {{ "{:,.0f}".format(w.comments) }}</span>
                  <span>‚ù§ {{ "{:,.0f}".format(w.favorites) }}</span>
                </div>
              </div>
            </div>

            <!-- right column -->
            <div class="md:col-start-3 md:row-start-1 grid justify-items-end gap-2">
              <div class="text-white/60 text-sm">{% if w.edited_at %}‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç {{ w.edited_at.strftime('%d %b %Y %H:%M ‡∏ô.') }}{% else %}-{% endif %}</div>
              <div class="relative status flex items-center gap-2" data-status="{{ w.status }}">
                {% set s = (w.status or '‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á') %}
                <span class="dot inline-block h-2.5 w-2.5 rounded-full {{ 'bg-gray-400' if s in ['‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà','‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß'] else 'bg-gray-600' }}"></span>
                <div class="relative">
                  <select name="status" data-id="{{ w.novels_id }}" class="statusSel select-reset rounded-lg border border-line bg-chip/90 px-3 py-2 pr-9 text-sm focus:outline-none focus:ring-2 focus:ring-accent/50">
                    <option value="‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á"  {{ 'selected' if s == '‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á'  else '' }}>‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á</option>
                    <option value="‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà"   {{ 'selected' if s == '‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà'   else '' }}>‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</option>
                    <option value="‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß"    {{ 'selected' if s == '‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß'    else '' }}>‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option>
                  </select>
                  <div class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-white/60">‚ñæ</div>
                </div>
                <button class="more ml-1 text-xl text-white/60 hover:text-white transition" title="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">‚ãØ</button>
                <div class="moreMenu absolute right-0 top-10 hidden min-w-44 rounded-xl border border-line bg-card/95 p-2 shadow-soft z-20">
                  <button class="menu-item" data-cmd="view">‡∏î‡∏π‡∏ú‡∏•‡∏á‡∏≤‡∏ô</button>
                  <button class="menu-item" data-cmd="edit">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                  <button class="menu-item" data-cmd="copy">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
                  <div class="my-1 border-t border-white/10"></div>
                  <button class="menu-item" style="color:#fca5a5" data-cmd="delete">‡∏•‡∏ö</button>
                </div>
              </div>
            </div>
          </article>
        {% endfor %}
      {% else %}
        <p class="opacity-70">‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</p>
      {% endif %}
    </section>
  </main>

  <!-- REMOTE MODAL: ‡πÇ‡∏´‡∏•‡∏î new_novel.html ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô iframe ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤‡∏î‡∏π‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô modal -->
  <div id="remoteModal" class="fixed inset-0 z-40 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" data-close="1"></div>
    <div id="remoteShell" class="relative w-full max-w-3xl rounded-2xl border border-line bg-card p-0 shadow-soft">
      <div class="flex items-center justify-between px-4 py-3 border-b border-white/10">
        <h2 class="text-lg font-bold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</h2>
        <button id="remoteClose" class="text-xl text-white/70 hover:text-white">‚úï</button>
      </div>
      <div class="p-4">
        <iframe id="remoteFrame" src="about:blank" allowtransparency="true"></iframe>
      </div>
    </div>
  </div>

  <script>
  // ========= Utilities =========
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
  function toast(msg, ok=true){
    const box = document.createElement('div');
    box.className = `fixed bottom-4 left-1/2 -translate-x-1/2 z-[60] rounded-xl border ${ok? 'border-white/10 bg-white/10':'border-red-400/40 bg-red-400/20'} backdrop-blur px-4 py-2 text-sm`;
    box.textContent = msg; document.body.appendChild(box); setTimeout(()=> box.remove(), 2000);
  }
  function closeAllMenus(){ $('#manageMenu')?.classList.add('hidden'); $('#filterMenu')?.classList.add('hidden'); $$('.moreMenu').forEach(m => m.classList.add('hidden')); }
  function visibleCount(){ const n = $$('#list article').filter(a => !a.classList.contains('hidden')).length; const label = $('#filterLabel'); if (label) label.textContent = label.textContent.replace(/\(.+?\)/, `(${n.toLocaleString()})`).replace(/‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î|‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà|‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß|‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á/, currentFilter); }

  // ========= List helpers =========
  function articleFromData(d){
    const html = `
    <article class="relative grid md:grid-cols-[auto,1fr,auto] grid-cols-1 gap-3 items-center rounded-xl border border-line bg-card/95 p-4 shadow-soft" data-id="${d.novels_id}" data-status="${d.status || '‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á'}" data-detail="${d.detail_url || '#'}">
      <div class="flex items-center gap-3">
        <input type="checkbox" class="itemChk h-5 w-5 rounded-md border border-white/20 bg-chip/70 text-accent focus:ring-2 focus:ring-accent/50" value="${d.novels_id}" />
        <img class="h-16 w-16 rounded-lg border border-white/10 object-cover" src="${d.cover_url || ''}" alt="${d.title || ''}" />
        <div class="min-w-0">
          <div class="text-[1.05rem] font-bold tracking-[.02em] truncate">
            <a href="/edit_novel/${d.novels_id}" class="no-underline text-white hover:text-accent transition">${d.title || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠)'}</a>
          </div>
          <div class="mt-0.5 flex flex-wrap items-center gap-3 text-white/70 text-[.92rem]">
            <span>${d.category_name || ''}</span>
            <span>‚Ä¢</span>
            <span class="rounded-full border border-white/10 bg-[#35363a] px-2 py-0.5">${d.author_username || '‡∏â‡∏±‡∏ô'}</span>
          </div>
          <div class="mt-1 flex flex-wrap items-center gap-4 text-white/60 text-[.9rem]">
            <span>üìö ${d.chapters || 0}</span>
            <span>üëÅÔ∏è ${(d.views||0).toLocaleString()}</span>
            <span>üí¨ ${(d.comments||0).toLocaleString()}</span>
            <span>‚ù§ ${(d.favorites||0).toLocaleString()}</span>
          </div>
        </div>
      </div>
      <div class="md:col-start-3 md:row-start-1 grid justify-items-end gap-2">
        <div class="text-white/60 text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${new Date().toLocaleString('th-TH')}</div>
        <div class="relative status flex items-center gap-2" data-status="${d.status || '‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á'}">
          <span class="dot inline-block h-2.5 w-2.5 rounded-full" style="background:${(d.status==='‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà'||d.status==='‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß') ? '#9ca3af':'#6b6b6b'}"></span>
          <div class="relative">
            <select name="status" data-id="${d.novels_id}" class="statusSel select-reset rounded-lg border border-line bg-chip/90 px-3 py-2 pr-9 text-sm focus:outline-none focus:ring-2 focus:ring-accent/50">
              <option ${!d.status||d.status==='‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á'?'selected':''} value="‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á">‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á</option>
              <option ${d.status==='‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà'?'selected':''} value="‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà">‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</option>
              <option ${d.status==='‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß'?'selected':''} value="‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß">‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option>
            </select>
            <div class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-white/60">‚ñæ</div>
          </div>
          <button class="more ml-1 text-xl text-white/60 hover:text-white transition" title="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å">‚ãØ</button>
          <div class="moreMenu absolute right-0 top-10 hidden min-w-44 rounded-xl border border-line bg-card/95 p-2 shadow-soft">
            <button class="menu-item" data-cmd="view">‡∏î‡∏π‡∏ú‡∏•‡∏á‡∏≤‡∏ô</button>
            <button class="menu-item" data-cmd="edit">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
            <button class="menu-item" data-cmd="copy">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
            <div class="my-1 border-t border-white/10"></div>
            <button class="menu-item" style="color:#fca5a5" data-cmd="delete">‡∏•‡∏ö</button>
          </div>
        </div>
      </div>
    </article>`;
    const tpl = document.createElement('template'); tpl.innerHTML = html.trim(); return tpl.content.firstElementChild;
  }

 // ========= Global handlers (‡πÄ‡∏î‡∏¥‡∏°) =========
  let currentFilter = '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
  document.addEventListener('click', (e)=>{ if (!e.target.closest('#manageBtn') && !e.target.closest('#manageMenu') && !e.target.closest('#filterBtn') && !e.target.closest('#filterMenu') && !e.target.closest('.more') && !e.target.closest('.moreMenu')){ closeAllMenus(); } });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeAllMenus(); if(!$('#remoteModal')?.classList.contains('hidden')) closeRemoteModal(); } });

  // Select all
  $('#checkAll')?.addEventListener('change', (e)=>{ const on = e.target.checked; $$('.itemChk').forEach(c=> c.checked = on); });

  // Manage dropdown
  $('#manageBtn')?.addEventListener('click', ()=>{ $('#manageMenu')?.classList.toggle('hidden'); $('#filterMenu')?.classList.add('hidden'); });
  $('#manageMenu')?.addEventListener('click', async (e)=>{
    const btn = e.target.closest('[data-action]'); if(!btn) return; const action = btn.dataset.action; closeAllMenus();
    const ids = $$('.itemChk:checked').map(i => i.value); if (ids.length===0) return toast('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', false);
    ids.forEach(id=>{ const art = document.querySelector(`article[data-id="${id}"]`); if (!art) return; if (action==='delete'){ art.remove(); } else { const st = action==='publish' ? '‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà' : action==='complete' ? '‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : '‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á'; art.dataset.status = st; const sel = art.querySelector('.statusSel'); sel.value = st; sel.setAttribute('data-prev', st); const dot = art.querySelector('.dot'); dot.style.background = (st==='‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà' || st==='‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß') ? '#9ca3af' : '#6b6b6b'; }});
    visibleCount();
    try{ const res = await fetch('/api/mywrite/bulk', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ids, action})}); if(!res.ok) throw new Error('HTTP '+res.status); const out = await res.json(); if (!out.ok) throw new Error(out.message || '‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'); toast('‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); }catch(err){ toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á: '+err.message, false); }
  });

  // Filter dropdown
  $('#filterBtn')?.addEventListener('click', ()=>{ $('#filterMenu')?.classList.toggle('hidden'); $('#manageMenu')?.classList.add('hidden'); });
  $('#filterMenu')?.addEventListener('click', (e)=>{
    const b = e.target.closest('[data-filter]'); if(!b) return; currentFilter = b.dataset.filter; $('#filterLabel').textContent = currentFilter; const arts = $$('#list article'); arts.forEach(a=>{ const st = a.dataset.status || '‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á'; a.classList.toggle('hidden', currentFilter!=='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' && st!==currentFilter); }); closeAllMenus(); visibleCount();
  });

  // Per-item status change
  function attachStatusHandlers(){ $$('.statusSel').forEach(sel => { sel.addEventListener('change', async () => { const s = sel.value; const id = sel.dataset.id; const dot = sel.closest('.status').querySelector('.dot'); dot.style.background = (s === '‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà' || s === '‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß') ? '#9ca3af' : '#6b6b6b'; sel.closest('article').dataset.status = s; try { const res = await fetch(`/api/mywrite/${id}/status`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ status: s }) }); const out = await res.json(); if (!res.ok || !out.ok) throw new Error(out.message || out.error || 'save failed'); sel.setAttribute('data-prev', s); toast('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÅ‡∏•‡πâ‡∏ß'); } catch (err) { toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+ err.message, false); sel.value = sel.getAttribute('data-prev') || '‡πÅ‡∏ö‡∏ö‡∏£‡πà‡∏≤‡∏á'; const s0 = sel.value; dot.style.background = (s0==='‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà'||s0==='‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß') ? '#9ca3af' : '#6b6b6b'; } visibleCount(); }); }); }
  attachStatusHandlers();

  // Per-item menu actions
  $('#list').addEventListener('click', async (e)=>{
    const moreBtn = e.target.closest('.more'); if (moreBtn){ const card = moreBtn.closest('article'); closeAllMenus(); card.querySelector('.moreMenu').classList.toggle('hidden'); return; }
    const cmdBtn = e.target.closest('.moreMenu [data-cmd]'); if (!cmdBtn) return; const card = cmdBtn.closest('article'); const id = card.dataset.id; const url = card.dataset.detail || '#'; const cmd = cmdBtn.dataset.cmd; closeAllMenus();
    if (cmd==='view') return location.href = url;
    if (cmd==='edit') return location.href = `/edit_novel/${id}`;
    if (cmd==='copy'){ await navigator.clipboard.writeText(url); return toast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÅ‡∏•‡πâ‡∏ß'); }
    if (cmd==='delete'){ const ok = confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ?'); if(!ok) return; card.remove(); visibleCount(); try{ const res = await fetch(`/api/mywrite/${id}`, {method:'DELETE'}); if(!res.ok) throw new Error('HTTP '+res.status); } catch(err){ toast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ö‡∏ô‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: '+err.message, false); } }
  });

  // ========= Remote modal (new_novel.html) =========
  const remoteModal = $('#remoteModal');
  const remoteFrame = $('#remoteFrame');
  const remoteShell = $('#remoteShell');

  const defaultNewUrl =
    $('#addBtn')?.getAttribute('data-new-url') ||
    $('#addBtn')?.getAttribute('href') ||
    '/new_novel';

  function openRemoteModal(url){
    if (!remoteModal || !remoteFrame) return;

    const target = url || defaultNewUrl;

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î
    remoteShell?.classList.add('is-loading');
    remoteModal.classList.remove('hidden');
    remoteModal.classList.add('flex');

    let finished = false;
    const finish = () => {
      if (finished) return;          // ‡∏Å‡∏±‡∏ô‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥
      finished = true;
      remoteShell?.classList.remove('is-loading');
    };

    remoteFrame.onload = () => {
      // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î modal ‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏´‡∏•‡∏î
      finish();
    };

    remoteFrame.onerror = () => {
      if (finished) return;
      finish();
      // ‡∏ñ‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ô modal ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ï‡πá‡∏°‡πÅ‡∏ó‡∏ô
      window.location.href = target;
    };

    remoteFrame.src = target;
  }

  function closeRemoteModal(){
    if (!remoteModal || !remoteFrame) return;

    remoteModal.classList.remove('flex');
    remoteModal.classList.add('hidden');

    remoteShell?.classList.remove('is-loading');

    // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå handler ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ onload ‡∏Ç‡∏≠‡∏á about:blank ‡∏î‡∏∂‡∏á modal ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏≠‡∏µ‡∏Å
    remoteFrame.onload = null;
    remoteFrame.onerror = null;
    remoteFrame.src = 'about:blank';
  }

  $('#addBtn')?.addEventListener('click', (e)=>{
    if (e.metaKey || e.ctrlKey || e.button === 1) return; // ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥
    e.preventDefault();
    openRemoteModal();
  });

  $('#remoteClose')?.addEventListener('click', (e)=>{
    e.preventDefault();
    closeRemoteModal();
  });

  // ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å backdrop
  remoteModal?.addEventListener('mousedown', (e)=>{
    if (e.target && e.target.getAttribute && e.target.getAttribute('data-close') === '1') {
      closeRemoteModal();
    }
  });

  // ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πâ‡∏≤ new_novel ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô iframe ‡∏™‡πà‡∏á postMessage('close-modal') ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡πÑ‡∏î‡πâ
  window.addEventListener('message', (ev)=>{
    if (ev?.data === 'close-modal') closeRemoteModal();
  });

  visibleCount();
  </script>
</body>
</html>
