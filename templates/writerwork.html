<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Writing ‚Äî Works (Monochrome)</title>

  <!-- current user id ‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå -->
  <meta name="current-user-id" content="{{ current_user_id or '' }}" />

  <!-- Fonts / Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Noto Sans Thai','ui-sans-serif','system-ui','-apple-system','Segoe UI','Roboto','Arial','sans-serif'] },
          boxShadow: { soft: '0 10px 24px rgba(0,0,0,.45)' }
        }
      }
    } 
  </script>
  <style>body{background:#0b0b0b}</style>
</head>
<body class="min-h-screen text-zinc-100 font-sans selection:bg-white/20 selection:text-zinc-100">
  <!-- HEADER -->
  <header class="sticky top-0 z-30 border-b border-white/10 bg-bg/80 backdrop-blur-md">
    {% include 'header.html' %}
  </header>

  <main class="max-w-6xl mx-auto p-5" data-writer-id="{{ writer_id }}">
    <!-- WRITER PANEL -->
    <section class="bg-neutral-900/70 border border-white/10 rounded-2xl shadow-soft p-5 md:p-6">
      <div class="grid grid-cols-[auto,1fr,auto] gap-4 items-center">
        <img class="w-20 h-20 md:w-24 md:h-24 rounded-full object-cover bg-zinc-300 border border-white/10"
             src="{{ writer.pfpic or '/static/img/avatar-placeholder.jpg' }}" alt="avatar"/>
        <div>
          <div class="text-2xl md:text-3xl font-bold">{{ writer.username }}</div>
          <div class="mt-1 flex flex-wrap gap-x-4 gap-y-1 text-zinc-300 text-sm">
            <span>‚úçÔ∏è ‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô {{ writer.work_count }} ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á</span>
            <span>üì• ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô {{ "{:,}".format(writer.total_bookshelf or 0) }} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <!-- Owner-only quick dashboard button -->
          <a href="/me/analytics" data-owner-only
             class="hidden inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/10 hover:bg-white/20 px-4 py-2 text-sm text-zinc-100 transition">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path d="M3 3h2v18H3V3Zm4 10h2v8H7v-8Zm4-6h2v14h-2V7Zm4 3h2v11h-2V10Zm4-6h2v17h-2V4Z"/></svg>
            ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
          </a>
          <button class="inline-flex items-center justify-center w-9 h-9 rounded-full border border-white/10 bg-white/5 hover:bg-white/15 text-zinc-200" aria-label="more">‚ãØ</button>
        </div>
      </div>
      <p class="mt-3 text-center text-zinc-400 italic">‚Äú‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏£‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‚Äù</p>
    </section>

    <!-- NAV/TABS + TOOLBAR -->
    <nav class="mt-4 bg-neutral-900/70 border border-white/10 rounded-2xl shadow-soft">
      <div class="px-5 pt-4">
        <div class="flex gap-5 border-b border-white/10">
          <button class="relative py-3 text-white font-semibold after:absolute after:inset-x-0 after:-bottom-px after:h-0.5 after:bg-white">‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô</button>
        </div>

        <div class="mt-3 mb-4 flex flex-wrap items-center gap-3">
          <div class="inline-flex rounded-full border border-white/10 p-1 bg-neutral-900">
            <button data-filter="all" class="filter-pill px-3 py-1.5 rounded-full text-sm bg-white text-black">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            <button data-filter="latest" class="filter-pill px-3 py-1.5 rounded-full text-sm hover:bg-white/10">‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
          </div>
          <div class="flex-1"></div>
          <label class="inline-flex items-center gap-2 text-sm text-zinc-300">
            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            <div class="relative">
              <select id="statusSelect" class="appearance-none bg-neutral-900 text-zinc-200 border border-white/10 focus:border-white/20 rounded-xl pl-3 pr-9 py-2.5 text-sm shadow-inner focus:outline-none focus:ring-2 focus:ring-white/20 transition">
                <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="finished">‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß</option>
                <option value="ongoing">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏à‡∏ö</option>
              </select>
              <span class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-zinc-400">‚ñæ</span>
            </div>
          </label>
        </div>
      </div>

      <!-- WORKS GRID -->
      <div id="works" class="grid gap-4 p-5 md:grid-cols-2">
        {% for w in works %}
        <article class="group relative flex gap-4 rounded-xl border border-white/10 bg-neutral-900/70 p-3 md:p-4 hover:ring-1 hover:ring-white/20 transition">
          <img class="w-[120px] h-[120px] rounded-lg object-cover bg-zinc-300" src="{{ w.cover }}" alt="cover"/>
          <div class="flex-1 min-w-0"
               data-novel-id="{{ w.novels_id }}"
               data-chapters="{{ w.chapters }}"
               data-views="{{ w.views }}"
               data-likes="{{ w.likes }}"
               data-bookmarks="{{ w.bookmarks }}"
               data-status="{{ w.status }}"
               data-updated="{{ w.updated_at }}"
               data-comments="{{ w.comments }}"
               data-rating="{{ w.rating_avg }}">
            <div class="flex items-center gap-2">
              <span title="‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î" class="inline-block w-2 h-2 rounded-full bg-zinc-300"></span>
              <h3 class="font-bold truncate">{{ w.title }}</h3>
              <div class="ml-auto flex items-center gap-2">
                <!-- Owner-only: view stats -->
                <button data-owner-only data-action="open-stats" data-id="{{ w.novels_id }}"
                        class="hidden inline-flex items-center gap-1 rounded-full border border-white/10 bg-neutral-800 hover:bg-neutral-700 px-3 py-1.5 text-sm font-medium text-white">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4"><path d="M3 3h2v18H3V3Zm4 10h2v8H7v-8Zm4-6h2v14h-2V7Zm4 3h2v11h-2V10Zm4-6h2v17h-2V4Z"/></svg>
                  ‡∏î‡∏π‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                </button>
                <a href="/novel/{{ w.novels_id }}" class="inline-flex items-center gap-1 rounded-full bg-white text-black px-3 py-1.5 text-sm font-medium">‡∏≠‡πà‡∏≤‡∏ô‡∏ï‡πà‡∏≠</a>
              </div>
            </div>
            <div class="text-zinc-300 text-sm">by {{ w.writer_name }}</div>
            <div class="mt-1 flex flex-wrap gap-3 text-zinc-300 text-sm">
              <span>üìÑ {{ w.chapters }}</span>
              <span>üëÅÔ∏è {{ "{:,}".format(w.views) }}</span>
              <span>‚ù§ {{ "{:,}".format(w.likes) }}</span>
            </div>
          </div>
        </article>
        {% endfor %}
      </div>
    </nav>
  </main>

  <!-- MODAL: Stats -->
  <div id="statsModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-2xl rounded-2xl border border-white/10 bg-neutral-900 shadow-soft">
        <div class="flex items-center justify-between px-5 py-4 border-b border-white/10">
          <h3 id="statsTitle" class="text-lg font-semibold">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢</h3>
          <button id="statsClose" class="w-9 h-9 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center" aria-label="close">‚úï</button>
        </div>
        <div id="statsBody" class="p-5 grid gap-4"><!-- Filled by JS --></div>
      </div>
    </div>
  </div>

  <script>
    // ===== Owner gate =====
    const currentUserId = document.querySelector('meta[name="current-user-id"]').content;
    const writerId = document.querySelector('main')?.dataset.writerId;
    const isOwner = currentUserId && writerId && currentUserId === writerId;
    document.querySelectorAll('[data-owner-only]').forEach(el => { if (isOwner) el.classList.remove('hidden'); });

    // ===== Filters =====
    const works = Array.from(document.querySelectorAll('#works > article > div.flex-1'));
    const pills = document.querySelectorAll('.filter-pill');
    const statusSelect = document.getElementById('statusSelect');

    function applyFilters() {
      const active = document.querySelector('.filter-pill.bg-white');
      const filter = active?.dataset.filter || 'all';
      const status = statusSelect.value;
      const container = document.getElementById('works');
      let items = works.slice();

      // status filter
      items.forEach(el => {
        const ok = status === 'all' ? true : el.dataset.status === status;
        el.closest('article').classList.toggle('hidden', !ok);
      });

      // sort (latest)
      if (filter === 'latest') {
        items.sort((a,b)=> new Date(b.dataset.updated) - new Date(a.dataset.updated));
        items.forEach(el => container.appendChild(el.closest('article')));
      }
    }

    pills.forEach(p => p.addEventListener('click', () => {
      pills.forEach(x => x.classList.remove('bg-white','text-black'));
      p.classList.add('bg-white','text-black');
      applyFilters();
    }));
    statusSelect.addEventListener('change', applyFilters);
    applyFilters();

    // ===== Stats Modal =====
    const modal = document.getElementById('statsModal');
    const statsBody = document.getElementById('statsBody');
    const statsTitle = document.getElementById('statsTitle');
    document.getElementById('statsClose').addEventListener('click', ()=> modal.classList.add('hidden'));
    modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.add('hidden'); });

    async function fetchStats(novelId, days=28) {
      try {
        const res = await fetch(`/api/novels/${novelId}/stats?days=${days}`, { headers: { 'Accept': 'application/json' } });
        if (res.ok) return await res.json();
      } catch (err) {
        console.error(err);
      }
      // fallback ‡∏à‡∏≤‡∏Å data-* ‡∏ñ‡πâ‡∏≤ API ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°
      const el = document.querySelector(`[data-novel-id="${novelId}"]`);
      const title = el?.querySelector('h3')?.textContent?.trim() || '‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢';
      return {
        title,
        chapters: Number(el?.dataset.chapters || 0),
        views: Number(el?.dataset.views || 0),
        likes: Number(el?.dataset.likes || 0),
        bookmarks: Number(el?.dataset.bookmarks || 0),
        comments_count: Number(el?.dataset.comments || 0),
        rating_avg: Number(el?.dataset.rating || 0),
        readers_unique: Math.round((Number(el?.dataset.views || 0)) * 0.6),
        completion_rate: 0.0,
        updated_at: el?.dataset.updated || new Date().toISOString(),
        timeseries: []
      }
    }

    function n(x){ return new Intl.NumberFormat('th-TH').format(x); }
    function p(x){ return (Number(x||0)*100).toFixed(1)+'%'; }
    function r(x){ return (Number(x||0)).toFixed(2); }

    function statCard(label, value){
      return `<div class="rounded-xl border border-white/10 bg-white/5 p-4">
        <div class="text-sm text-zinc-300">${label}</div>
        <div class="mt-1 text-2xl font-semibold">${value}</div>
      </div>`
    }

    // === NEW timeseries layout (‡∏ï‡∏≤‡∏° API: date, views, unique_readers, new_completions, avg_progress) ===
    function renderTimeseries(rows){
      const head = `<div class="grid grid-cols-5 text-sm text-zinc-300">
        <div>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
        <div class="text-right">‡∏¢‡∏≠‡∏î‡∏î‡∏π</div>
        <div class="text-right">‡∏ú‡∏π‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥</div>
        <div class="text-right">‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏ö‡πÉ‡∏´‡∏°‡πà</div>
        <div class="text-right">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
      </div>`;
      const body = (rows || []).map(r=> `<div class="grid grid-cols-5 py-2 border-t border-white/10">
        <div>${r.date}</div>
        <div class="text-right">${n(r.views)}</div>
        <div class="text-right">${n(r.unique_readers || 0)}</div>
        <div class="text-right">${n(r.new_completions || 0)}</div>
        <div class="text-right">${(Number(r.avg_progress || 0)).toFixed(1)}%</div>
      </div>`).join('');
      return `<div class="rounded-xl border border-white/10 bg-white/5 p-4">${head}${body || '<div class="text-sm text-zinc-400 mt-2">‚Äî ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äî</div>'}</div>`;
    }

    async function openStats(novelId){
      if (!isOwner) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô
      const data = await fetchStats(novelId);
      const title = data.title || document.querySelector(`[data-id="${novelId}"]`)?.closest('[data-novel-id]')?.querySelector('h3')?.textContent?.trim();
      statsTitle.textContent = `‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢ ‚Äî ${title}`;

      statsBody.innerHTML = `
        <div class="grid gap-4 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4">
          ${statCard('‡∏ï‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', n(data.chapters))}
          ${statCard('‡∏¢‡∏≠‡∏î‡∏î‡∏π‡∏£‡∏ß‡∏°', n(data.views))}
          ${statCard('‡∏ú‡∏π‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥', n(data.readers_unique))}
          ${statCard('‡πÑ‡∏•‡∏Å‡πå‡∏£‡∏ß‡∏°', n(data.likes))}
          ${statCard('‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏±‡πâ‡∏ô', n(data.bookmarks))}
          ${statCard('‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', n(data.comments_count))}
          ${statCard('‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢', r(data.rating_avg) + ' / 5')}
          ${statCard('‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏ö (‡∏à‡∏£‡∏¥‡∏á)', p(data.completion_rate))}
        </div>
        <div class="grid gap-3">
          <div class="text-sm text-zinc-300">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${new Date(data.updated_at).toLocaleString('th-TH')}</div>
          ${renderTimeseries(data.timeseries || [])}
        </div>`;

      modal.classList.remove('hidden');
    }

    document.querySelectorAll('[data-action="open-stats"]').forEach(btn=>{
      btn.addEventListener('click', ()=> openStats(btn.dataset.id));
    });
  </script>
</body>
</html>
